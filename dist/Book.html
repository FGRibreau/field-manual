<h1 id="introduction">Introduction</h1>
<p>Welcome to the OrbitDB Field Manual. This book serves as a technical manual to the <em>distributed</em>, <em>decentralized</em>, <em>peer-to-peer</em> database engine known as <em>OrbitDB</em>, and also provides higher-level context for peer-to-peer technologies and ways of thinking.</p>
<p>Please read the introduction first and then feel free to skip ahead to the relevant part or parts that interest you. <a href="..//01_Tutorial">Parts 1</a> and <a href="..//03_The_Architecture_of_OrbitDB">3</a> are more technical in focus, and <a href="..//02_What_is_OrbitDB">Parts 2</a> and <a href="..//04_Warning">4</a> are more prosaic.</p>
<h2 id="a-different-perspective-on-centralized-power">A different perspective on centralized power</h2>
<p>We think there’s enough writing out there about the evils of centralization.</p>
<p>Instead, we want to offer a more positive perspective: Every third-party company that has come before us, every technology that they have created, and every piece of data they have stored in their silos has collectively provided a vast set of opportunities for us to build off of inside the decentralized space. We believe that the ziggurat of the centralized is not only a pedestal for us to stand on, but also a springboard for us to leap off of into a bright future - filled with new products and services as yet unimagined.</p>
<p>We now have the capabilities to create distributed, decentralized applications where:</p>
<ul>
<li>The user is in full control of their own data.</li>
<li>Third-party applications ask permission to run their code locally, instead of on their servers.</li>
<li>Peers connect directly to each other, without third parties.</li>
<li>Applications start as GDPR and HIPAA compliant, never revealing sensitive information.</li>
<li>Every layer of the application can be swapped out and configured: the data layer, the middleware, and the UI layer, creating hyper-customizable experiences.</li>
<li>Industries once thought intractable can be served: finance, healthcare, manufacturing, and more.</li>
</ul>
<p>We truly believe that everything past, for better or worse, is a prologue to this, and we’re so glad you’re with us.</p>
<h2 id="what-is-orbitdb">What is OrbitDB?</h2>
<p>OrbitDB is a database engine that is built on top of the <em>Interplanetary File System</em>, or <em>IPFS</em>.</p>
<p>You can consider <em>IPFS</em> to be the distributed “hard drive” where all data are content-addressed and retrievable from a peer-to-peer swarm. It then follows that <em><a href="https://github.com/orbitdb/orbit-db">OrbitDB</a></em> is the distributed database that lives on that hard drive.</p>
<p>OrbitDB creates and manages mutable databases and provides an extremely simple interface, centered around the IPFS <code>get</code> and <code>set</code> functions. From these simple underpinnings, OrbitDB manages a great deal of complexity to store these databases, in a distributed fashion, on IPFS. OrbitDB achieves this by building structures called <em>Conflict-free Replicated Data Types</em>, or <em>CRDTs</em>. CRDTs are essentially logs with specifically-formatted “clock” values that allow multiple users to perform independent and asynchronous operations on the same distributed database. When the peers share these logs with each other, the clock values ensure that there is no ambiguity about how their disparate entries will be put back together.</p>
<p>Beyond that, what should you as the developer understand about OrbitDB?</p>
<h3 id="orbitdb-is-written-in-javascript">OrbitDB is written in JavaScript</h3>
<p>OrbitDB is packaged as a Node.js library, available <a href="https://github.com/orbitdb/orbit-db">here</a>. JavaScript was chosen because of its popularity in the programming community, its ubiquity in web browsers, and its interoperability with the JavaScript implementation of IPFS, called <a href="https://github.com/ipfs/js-ipfs"><em>js-ipfs</em></a>.</p>
<p>Work is currently underway to allow support for other programming languages via a common HTTP API.</p>
<h3 id="orbitdb-is-not-a-blockchain">OrbitDB is NOT a Blockchain</h3>
<p>OrbitDB operates on the model of <em>strong eventual consistency</em> meaning that operations can be taking place at places and times that you are unaware of, with the assumption that you’ll eventually connect with peers, share your logs, and sync your data. This contrasts with Blockchain’s idea of <em>strong consistency</em> where entries are added to the database only after they have been verified by some distributed consensus algorithm.</p>
<p>There is no built-in “double spend” protection in OrbitDB - that is on you, the developer, to implement.</p>
<h3 id="orbitdb-is-free-as-in-freedom-software">OrbitDB is free (as in freedom) software</h3>
<p>OrbitDB is released under the MIT software license, which is an exceedingly permissible license. Organizations and individual developers are free to fork, embed, modify, and contribute to the code with no obligations from you, or from us. Of course, this also means there are no warranties as well.</p>
<h3 id="orbitdb-is-a-tool-for-you-the-developer-to-build-distributed-applications">OrbitDB is a tool for you, the developer, to build distributed applications</h3>
<p>Outside of a reference implementation called <a href="https://github.com/orbitdb/orbit-web">Orbit Chat</a>, the OrbitDB team primarily focuses on making OrbitDB more robust, reliable, and performant. Our mission is to enable you, the developer, to build distributed applications that will break into the mainstream and allow your users true sovereignty and control over their data.</p>
<h2 id="what-can-i-use-orbitdb-for">What can I use OrbitDB for?</h2>
<p>We want to believe that any application that can be built using traditional models can be built with a peer-to-peer architecture, but overall OrbitDB excels in flexibly building complex distributed applications.</p>
<h3 id="who-is-already-using-orbitdb">Who is already using OrbitDB?</h3>
<p>Perhaps the best way to answer your question of “What can I build with OrbitDB?” is by example. There are already several organizations using OrbitDB in the wild. We maintain a registry called <a href="https://github.com/orbitdb/awesome-orbitdb">Awesome OrbitDB</a> with several applications and libraries built with OrbitDB. If you’re looking for ideas for your own app, maybe start here.</p>
<p>Also, if you have a project you want to show off, <a href="https://github.com/orbitdb/awesome-orbitdb">Awesome OrbitDB</a> accepts issues and pull requests.</p>
<h2 id="a-warning">A Warning</h2>
<p>OrbitDB, and the underlying IPFS layer, are currently <em>alpha software</em>. There have already been high-severity bugs, API-breaking changes, and security disclosures, and there are more ahead. This is generally transparently communicated, yet these warnings have not stoped large organizations from using these tools in production.</p>
<p>If that sounds bad, don’t worry. It gets worse.</p>
<p>Not only are these tools alpha, but the <strong>entire decentralized industry is in an alpha state</strong>. There are unsolved problems not just technical in nature but also legal, political, economic, and societal. The wave of the personal computer revolution crashed on the shores of the information age, the wave of the mobile revolution crashed on the shores of the social age, and now we’re here, riding the crest of the wave of decentralization. We don’t know where we’re going to land yet, but we know it’s gonna be a bumpy ride. Get your life jackets on.</p>
<p>You may hear claims of what type of age might follow this, but it’s truly impossible to tell. Whatever it may be, it’s probably safe to say that the world will not be ready for it. It is our hope that you find this challenging and exciting, but don’t be surprised by feeling a healthy dose of trepidation, and even downright horror at times.</p>
<p>That all being said: welcome to the first days of our distributed future.</p>
<h3 id="up-next-in-the-book">Up next in the book</h3>
<p>Next up is <a href="..//01_Tutorial">Part 1: The OrbitDB Tutorial</a>. This is a long form tutorial that will introduce a new coder to all the important aspects of OrbitDB. If you are not a coder and simply wish to understand the nature of decentralization and peer-to-peer technologies, check out <a href="../02_Thinking_Peer_to_Peer">Part 2: Thinking Peer-to-Peer</a> or <a href="../04_What_Next">Part 4: What’s Next?</a>.</p>
<h2 id="who-wrote-this">Who wrote this</h2>
<p>This book has been written largely by the amazing Mark Henderson (don’t worry, someone else included the word amazing – he’s actually quite humble.). However, it is also a collaborative effort.</p>
<p>If you’re interested in writing any section of this book, head to the GitHub repository at <a href="https://github.com/orbitdb/field-manual">orbitdb/field-manual</a> where you can suggest new sections, point out bugs in some code, or just edit some spelling errors.</p>
<p>Anyone who contributes will have their name put into future versions of this book. We’ll add you if you contribute something. Here’s a list of contributors, so far, in alphabetical order.</p>
<ul>
<li>Haad <span class="citation" data-cites="haadcode">[@haadcode]</span>(https://github.com/haadcode)</li>
<li>Juuso Räsänen <span class="citation" data-cites="sirfumblestone">[@sirfumblestone]</span>(https://github.com/sirfumblestone)</li>
<li>Mark Henderson (<span class="citation" data-cites="aphelionz">[@aphelionz]</span>(https://github.com/aphelionz))</li>
<li>Richard Littauer (<span class="citation" data-cites="RichardLitt">[@RichardLitt]</span>(https://github.com/RichardLitt))</li>
<li><span class="citation" data-cites="shamb0t">[@shamb0t]</span>(https://github.com/shamb0t)</li>
<li>Teemu</li>
<li>Vesa-Ville <span class="citation" data-cites="vvp">[@vvp]</span>(https://github.com/vvp)</li>
</ul>
<p>If you would prefer not to be in this list, or to provide some different metadata, let us know!</p>
<h1 id="part-1-the-orbitdb-tutorial">Part 1: The OrbitDB Tutorial</h1>
<blockquote>
<p>An interactive, imperative and isomorphic JavaScript adventure of peer-to-peer, decentralized, and distributed proportions.</p>
</blockquote>
<h2 id="introduction-1">Introduction</h2>
<p>In order to maximize accessibility this tutorial does not favor either Node.js or the browser, since the same OrbitDB code runs on both. By following this tutorial step-by-step, your goal will be to build a <em>library</em> in the form of a JavaScript class that empowers a UI developer (CLI or Web) to build out a fully-realized application.</p>
<h3 id="requirements">Requirements</h3>
<ul>
<li>A computer with a command line (UNIX/Linux based or Windows command prompt)</li>
<li>A modern web browser (Firefox, Chrome, Edge, etc)</li>
<li>Node.js (optional)</li>
</ul>
<h3 id="what-will-i-learn">What will I learn?</h3>
<p>In the following chapters you will learn the following topics.</p>
<ol type="1">
<li><a href="./01_Basics.md">Laying the Foundation</a> covers the installation of IPFS and OrbitDB and the basics of database creation.</li>
<li><a href="./02_Managing_Data.md">Managing Data</a> introduces OrbitDB data stores and walks you through basic create, update, and delete methods of OrbitDB.</li>
<li><a href="./03_Structuring_Data.md">Structuring Data</a> suggests some ways to structure multiple OrbitDBs into a more robust schema.</li>
<li><a href="./04_P2P_Part_1.md">Peer-to-peer, Part 1 (IPFS)</a> begins a large discussion of peer-to-peer networking and messaging, starting with the IPFS layer.</li>
<li><a href="./05_P2P_Part_2.md">Peer-to-peer, Part 2 (OrbitDB)</a> adds OrbitDB to the mix through database discovery, connection, and replication.</li>
<li><a href="./06_Identity_Permission.md">Identity and Permissions</a> hardens the library via encryption and distributed identity.</li>
</ol>
<p>This tutorial is a work in progress, and individuals should feel encouraged to submit pull requests and provide feedback.</p>
<h3 id="what-will-i-build">What will I build?</h3>
<p>If you are a musician, you probably need some form of sheet music to practice. While any musician tends to spend hours practicing alone, the beauty of music is its ability to <em>connect</em> musicians to play together - forming duets, trios, quartets, septets, all the way up to orchestras.</p>
<p>These self-organizing clusters of musicians will always need better ways to share common and necessary sheet music with each other. What better use case for a peer-to-peer application?</p>
<p>Using OrbitDB as the backbone, you will build a JavaScript class that enables such an application. It will allow people to import and maintain a local collection of their own sheet music in the form of PDF files. More importantly, they will be able to <em>share</em> this music by letting them interface with <em>peers</em>, and search across multiple distributed databases at once for music. For fun, and for users who are just looking for something to sight-read, you will give them a magic “button” that, given an instrument, will display a piece of sheet music at random from their collection.</p>
<h4 id="why-a-music-app">Why a music app?</h4>
<p>OrbitDB is already used all over the world, and we believe that <strong>music</strong> is a uniquely universal cultural feature - something that all humans share, enjoy, or at least appreciate. Your participation in this tutorial will make it easier for musicians all over the world to find sheet music to practice with. This isn’t a naïve overstatement; it is really possible that what you make here will functionally be usable immediately, as a solid MVP, by actual musicians - and we encourage you to let us know if you know anyone who does end up using it! Some MVPs are make-and-forget; this one will stand on its own legs.</p>
<p>Admittedly, a music app is somewhat arbitrary. But if you’re here to learn more about OrbitDB, you’ll get what you came for.</p>
<h3 id="conventions">Conventions</h3>
<ul>
<li>This tutorial is:
<ul>
<li><em>Imperative</em>, meaning that it contains instructions you will follow</li>
<li><em>Interactive</em>, meaning you are meant to code as you read</li>
<li><em>Isomorphic</em>, meaning that it will work in the browser or command line, whichever you choose</li>
</ul></li>
<li>Read this tutorial in order, the learning builds on itself over time.</li>
<li>The UI Layer for this library is <em>suggested</em>, instead of built directly. The tutorial focuses on the building of a single JavaScript class which encapsulates all the functionality needed to build the UI layer.</li>
<li>Type the examples in, do not copy and paste.</li>
<li><strong>What just happened?</strong> sections are interspersed to explain in depth what happens on a technical level</li>
<li>This tutorial attempts to be as <em>agnostic</em> as possible in terms of:
<ul>
<li>Your operating system. Some command line commands are expressed as UNIX commands, but everything here should work on Windows as well.</li>
<li>Your folder structure. All of the code here is written in a single file, <code>newpieceplease.js</code></li>
<li>Your editor. Use whatever you want.</li>
<li>Your UI layer. You will see <em>examples</em> of how the code will be used on the UI layer, be it command line or browser based, but you will not be building out the UI as part of the tutorial steps.</li>
</ul></li>
<li><code>async</code> and <code>await</code> are used prominently. Feel free to replace those with explicit <code>Promise</code> objects if you like.</li>
<li>Steps that <strong>you</strong> should complete are represented and highlighted as <em>diffs</em>. Example application code is represented as JavaScript<br />
</li>
<li>For the sake of keeping things focused, we will exclude any HTML or CSS from this tutorial and focus only on the JavaScript code.</li>
<li><em>Italicized</em> words are words which we think you should learn to become familiar with.</li>
<li><strong>Bolded</strong> words are merely for textual emphasis. We want to make sure you don’t miss something!</li>
<li>Some typographical errors and misspellings - Javascript for JavaScript, decentralised instead of decentralized, and so on - will sneak in. If you see something, open a PR with a change! Check out our GitHub repository that this document is hosted in. All contributors will be credited.</li>
</ul>
<p><strong>Ready? Start with <a href="./01_Basics.md">Chapter 1: Laying the Foundation</a></strong></p>
<h2 id="chapter-1---laying-the-foundation">Chapter 1 - Laying the Foundation</h2>
<blockquote>
<p>The basics of OrbitDB include installing OrbitDB (and IPFS), setting up an isomorphic project that runs in both Node.js and the browser, creating databases, and understanding how to choose datastores.</p>
</blockquote>
<div>
<h3>
Table of Contents
</h3>
<p>Please see the <a href="./00_Introduction.md">Introduction</a> before beginning this chapter.</p>
<ul>
<li><a href="#installing-the-requirements-ipfs-and-orbitdb">Installing the requirements: IPFS and OrbitDB</a></li>
<li><a href="#instantiating-ipfs-and-orbitdb">Instantiating IPFS and OrbitDB</a></li>
<li><a href="#creating-a-database">Creating a database</a></li>
<li><a href="#choosing-a-data-store">Choosing a datastore</a></li>
<li><a href="#key-takeaways">Key takeaways</a></li>
</ul>
</div>
<h3 id="installing-the-requirements-ipfs-and-orbitdb">Installing the requirements: IPFS and OrbitDB</h3>
<p>Before you start working on the core functionality behind the peer-to-peer sharing of sheet music, you’ll need to get the foundations of our distributed database set up.</p>
<p>You will need to get the code for OrbitDB and its dependency, IPFS, and make it available to your project. The process is different between the browser and Node.js, so we cover both here.</p>
<blockquote>
<p><strong>Note</strong>: Both OrbitDB and js-ipfs are open source, which give you the ability to build and even contribute to the code. This will be covered in detail in <a href="../03_The_Architecture_of_OrbitDB">Part 3</a>.</p>
</blockquote>
<h4 id="in-node.js">In Node.js</h4>
<p>Choose a project directory and <code>cd</code> to there from your command line. Then run the following command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> npm init <span class="at">--yes</span> <span class="co"># use npm defaults, you can edit this later</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> npm install <span class="at">--save</span> orbit-db ipfs</span></code></pre></div>
<p>This will create a <code>package.json</code>, <code>package-lock.json</code>, and <code>node_modules</code> folder.</p>
<blockquote>
<p><strong>Note:</strong> If you’re running on a Windows prompt, or if you don’t have certain build tools like <a href="https://gcc.gnu.org"><code>g++</code></a> and <a href="https://www.python.org"><code>python</code></a> installed, you may see a noisy console output with lots of warnings and errors. Keep going, your code should still run.</p>
</blockquote>
<p>If you want to use Git to track your progress, we also suggest the following:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git init</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> echo node_modules <span class="op">&gt;</span> .gitignore</span></code></pre></div>
<p>Of course, be careful before copying and pasting any commands anyone ever tells you into your terminal. If you don’t understand a command, figure out what it is supposed to do, before copying it over. Copy and paste at your own risk.</p>
<blockquote>
<p><strong>Note:</strong> This code was tested on Node v11.14.0. Your mileage for other versions may vary.</p>
</blockquote>
<h4 id="in-the-browser">In the Browser</h4>
<p>If you’re using the browser for this tutorial, we recommend using <a href="https://www.unpkg.com">unpkg</a> for obtaining pre-built, minified versions of both IPFS and OrbitDB. Simply include these in your HTML:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;https://unpkg.com/ipfs@0.55.1/dist/index.min.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;https://unpkg.com/orbit-db@0.26.1/dist/orbitdb.min.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span></code></pre></div>
<p>You will now have global <code>Ipfs</code> and <code>OrbitDB</code> objects available to you. You will see how we’ll use these later.</p>
<h3 id="creating-the-isomorphic-bookends">Creating the isomorphic bookends</h3>
<p>Since OrbitDB works in the browser and Node.js, you’re going to want to make the library as <em>isomorphic</em> as possible. This means we want the same code to run in the browser as runs in REPL or local environment. Luckily, you will have the luxury of using the same language, JavaScript, for both Node.js and browser environments.</p>
<p>Create a new file called <code>newpieceplease.js</code> and put this code in there:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NewPiecePlease {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (Ipfs<span class="op">,</span> OrbitDB) {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">Ipfs</span> <span class="op">=</span> Ipfs</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">OrbitDB</span> <span class="op">=</span> OrbitDB</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> {</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Ipfs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;ipfs&#39;</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> OrbitDB <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;orbit-db&#39;</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> exports <span class="op">=</span> <span class="kw">new</span> <span class="fu">NewPiecePlease</span>(Ipfs<span class="op">,</span> OrbitDB)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>} <span class="cf">catch</span> (e) {</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="at">NPP</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">NewPiecePlease</span>(<span class="bu">window</span><span class="op">.</span><span class="at">Ipfs</span><span class="op">,</span> <span class="bu">window</span><span class="op">.</span><span class="at">OrbitDB</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Source: <a href="https://github.com/orbitdb/field-manual/blob/a5459ac56402f620cab424c6c399f7c593e94f85/code_examples/01_01_newpieceplease.js">GitHub</a>, or on IPFS at <code>QmRZycUKy3MnRKRxkLu8jTzBEVHZovsYcbhdiwLQ221eBP</code>.</p>
<p>In the browser, you can include this file in a script tag and have an <code>NPP</code> object at your disposal. In Node.js, you can simply call something like:</p>
<pre class="plain"><code>$ node

&gt; const NPP = require(&#39;./newpieceplease&#39;)</code></pre>
<p>Not much should happen either way, since there’s not much code there yet. For now just make sure you can create the <code>NPP</code> constant.</p>
<h4 id="what-just-happened">What just happened?</h4>
<p>Using some key JavaScript features, you have created the shell for our application that runs in both Node.js and the browser. It defines a new class called <code>NewPiecePlease</code>, with a constructor that takes two arguments</p>
<ol type="1">
<li><code>IPFS</code> for the <code>js-ipfs</code> constructor</li>
<li><code>OrbitDB</code> for the <code>orbit-db</code> constructor</li>
</ol>
<p>From here on out, we will ignore these isometric bookends and concentrate wholly on the <code>NewPiecePlease</code> class.</p>
<h3 id="instantiating-ipfs-and-orbitdb">Instantiating IPFS and OrbitDB</h3>
<p>OrbitDB requires a running IPFS node to operate, so you will create one here and notify OrbitDB about it.</p>
<blockquote>
<p><strong>Note:</strong> We have designed Chapters 1 and 2 of the tutorial to work offline, not requiring any internet connectivity or connections to peers.</p>
</blockquote>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NewPiecePlease {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (Ipfs<span class="op">,</span> OrbitDB) {</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">OrbitDB</span> <span class="op">=</span> OrbitDB</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">Ipfs</span> <span class="op">=</span> Ipfs</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">create</span>() {</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">node</span> <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">Ipfs</span><span class="op">.</span><span class="fu">create</span>({</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">preload</span><span class="op">:</span> { <span class="dt">enabled</span><span class="op">:</span> <span class="kw">false</span> }<span class="op">,</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">repo</span><span class="op">:</span> <span class="st">&#39;./ipfs&#39;</span><span class="op">,</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">EXPERIMENTAL</span><span class="op">:</span> { <span class="dt">pubsub</span><span class="op">:</span> <span class="kw">true</span> }<span class="op">,</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">config</span><span class="op">:</span> {</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Bootstrap</span><span class="op">:</span> []<span class="op">,</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Addresses</span><span class="op">:</span> { <span class="dt">Swarm</span><span class="op">:</span> [] }</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">_init</span>()</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">_init</span> () {</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">orbitdb</span> <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">OrbitDB</span><span class="op">.</span><span class="fu">createInstance</span>(<span class="kw">this</span><span class="op">.</span><span class="at">node</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">defaultOptions</span> <span class="op">=</span> { <span class="dt">accessController</span><span class="op">:</span> {</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">write</span><span class="op">:</span> [<span class="kw">this</span><span class="op">.</span><span class="at">orbitdb</span><span class="op">.</span><span class="at">identity</span><span class="op">.</span><span class="at">id</span>]</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Source: <a href="../code_examples/01_Tutorial/02_Managing_Data">GitHub</a>.</p>
<p>This allows you to run something like the following in your application code:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>NPP<span class="op">.</span><span class="at">onready</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>   <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(NPP<span class="op">.</span><span class="at">orbitdb</span><span class="op">.</span><span class="at">id</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>NPP<span class="op">.</span><span class="fu">create</span>()</span></code></pre></div>
<p>In the output you will see something called a “multihash”, like <code>QmPSicLtjhsVifwJftnxncFs4EwYTBEjKUzWweh1nAA87B</code>. This is the identifier of your IPFS node. (You may have noticed we referenced multihashes above for the code examples: these are the multihashes you can use to download the example code files, if GitHub is down.)</p>
<h4 id="what-just-happened-1">What just happened?</h4>
<p>Once calling <code>create</code>, the <code>Ipfs.create</code> line creates a new IPFS node. Note the default settings:</p>
<ul>
<li><code>preload: { enabled: false }</code> disables the use of so-called “pre-load” IPFS nodes. These nodes exist to help load balance the global network and prevent DDoS. However, these nodes can go down and cause errors. Since we are only working offline for now, we include this line to disable them.</li>
<li><code>repo: './ipfs'</code> designates the path of the repo in Node.js only. In the browser, you can actually remove this line. The default setting is a folder called <code>.jsipfs</code> in your home directory. You will see why we choose this specific location for the folder later.</li>
<li><code>EXPERIMENTAL: { pubsub: true }</code> enables <a href="https://blog.ipfs.io/25-pubsub/">IPFS pubsub</a>, which is a method of communicating between nodes and <strong>is required for OrbitDB usage</strong>, despite whether or not we are connected to other peers.</li>
<li><code>config: { Bootstrap: [], Addresses: { Swarm: [] }}</code> sets both our bootstrap peers list (peers that are loaded on instantiation) and swarm peers list (peers that can connect and disconnect at any time to empty. We will populate these later.</li>
<li><code>node.on("error", (e) =&gt; { throw new Error(e) })</code> implements extremely basic error handling if something happens during the creation of the IPFS node.</li>
<li><code>node.on("ready", (e) =&gt; { orbitdb = new OrbitDB(node) })</code> instantiates OrbitDB on top of the IPFS node when it is ready.</li>
</ul>
<p>By running the code above, you have created a new IPFS node that works locally and is not connected to any peers. You have also loaded a new <code>orbitdb</code> object into memory, ready to create databases and manage data.</p>
<p><em>You are now ready to use OrbitDB!</em></p>
<h5 id="what-else-happened-in-node.js">What else happened in Node.js?</h5>
<p>When you ran the code in Node.js, you created two folders in your project structure: <code>'orbitdb/</code> and <code>ipfs/</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> <span class="co"># slashes added to ls output for effect</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls orbitdb/</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">QmNrPunxswb2Chmv295GeCvK9FDusWaTr1ZrYhvWV9AtGM/</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls ipfs/</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="ex">blocks/</span>  config  datastore/  datastore_spec  keys/  version</span></code></pre></div>
<p>Looking inside the <code>orbitdb/</code> folder you will see that the subfolder has the same ID as orbitdb, as well as the IPFS node. This is purposeful, as this initial folder contains metadata that OrbitDB needs to operate. See Part 3 for detailed information about this.</p>
<p>The <code>ipfs/</code> folder contains all of your IPFS data. Explaining this in depth is outside of the scope of this tutorial, but the curious can find out more <a href="https://ipfs.io">here</a>.</p>
<h5 id="what-else-happened-in-the-browser">What else happened in the browser?</h5>
<p>In the browser IPFS content is handled inside of IndexedDB, a persistent storage mechanism for browsers</p>
<figure>
<img src="../images/ipfs_browser.png" alt="An image showing the IPFS IndexedDB databases in Firefox" /><figcaption aria-hidden="true">An image showing the IPFS IndexedDB databases in Firefox</figcaption>
</figure>
<p>Note since you have not explicitly defined a database in the browser, no IndexedDB databases have been created for OrbitDB yet.</p>
<blockquote>
<p><strong>Caution!</strong> iOS and Android have been known to purge IndexedDB if storage space needs to be created inside of your phone. We recommend creating robust backup mechanisms at the application layer</p>
</blockquote>
<h3 id="creating-a-database">Creating a database</h3>
<p>Your users will want to create a catalog of musical pieces to practice. You will now create this database, and ensure that <em>only that user</em> can write to it.</p>
<p>Expand of your <code>_init</code> function to the following:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>  async _init () {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    this.orbitdb = await OrbitDB.createInstance(node)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   this.defaultOptions = { accessController: { write: [this.orbitdb.identity.id] }}</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="va">+   const docStoreOptions = {</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="va">+     ...this.defaultOptions,</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="va">+     indexBy: &#39;hash&#39;,</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="va">+   }</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="va">+   this.pieces = await this.orbitdb.docstore(&#39;pieces&#39;, docStoreOptions)</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>Then, in your application code, run this:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>NPP<span class="op">.</span><span class="at">onready</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>   <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(NPP<span class="op">.</span><span class="at">pieces</span><span class="op">.</span><span class="at">id</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>You will see something like the following as an output: <code>/orbitdb/zdpuB3VvBJHqYCocN4utQrpBseHou88mq2DLh7bUkWviBQSE3/pieces</code>. This is the id, or <strong>address</strong> (technically a multiaddress) of this database. It is important for you to not only <em>know</em> this, but also to understand what it is. This string is composed of 3 parts, separated by <code>/</code>s:</p>
<ol type="1">
<li>The first bit, <code>/orbitdb.</code>, is the protocol. It tells you that this address is an OrbitDB address.</li>
<li>The second, or middle, part <code>zdpuB3VvBJHqYCocN4utQrpBseHou88mq2DLh7bUkWviBQSE3</code> that is the most interesting. This is the Content ID (CID) of the database manifest, which contains:
<ul>
<li>The <strong>access control list</strong> of the database</li>
<li>The <strong>type</strong> of the database</li>
<li>The <strong>name</strong> of the database</li>
</ul></li>
<li>The final part is the name you provided, in this case <code>pieces</code>, which becomes the final part of the multiaddress</li>
</ol>
<blockquote>
<p><em>Note:</em> Addresses that start with Qm… are typically CIDv0 content addresses, while addresses that start with zdpu…. are CIDv1. Misunderstanding OrbitDB addresses can lead to some very unexpected - sometimes hilarious, sometimes disastrous outcomes.</p>
</blockquote>
<h4 id="what-just-happened-2">What just happened?</h4>
<p>Your code created a local OrbitDB database, of type “docstore”, writable only by the user who created it.</p>
<ul>
<li><code>defaultOptions</code> and <code>docStoreOptions</code> define the parameters for the database we are about to create.
<ul>
<li><code>accessController: { write: [orbitdb.identity.id] }</code> defines the ACL, or “Access Control List”. In this instance we are restricting <code>write</code> access to ONLY the OrbitDB instances identified by our particular <code>id</code></li>
<li><code>indexBy: "hash"</code> is a docstore-specific option, which specifies which field to index our database by</li>
</ul></li>
<li><code>pieces = await orbitdb.docstore('pieces', options)</code> is the magic line that creates the database. Once this line is completed, the database is open and can be acted upon.</li>
</ul>
<blockquote>
<p><strong>Caution!</strong> A note about identity: Your public key is not your identity. We repeat, <em>your public key is not your identity</em>. That being said, it is often used as such for convenience’s sake, and the lack of better alternatives. So, in the early parts of this tutorial we say “writable only to you” when we really mean “writable only by an OrbitDB instance on top of an IPFS node that has the correct id, which we are assuming is controlled by you.”</p>
</blockquote>
<h5 id="what-else-happened-in-node.js-1">What else happened in Node.js?</h5>
<p>You will see some activity inside your project’s <code>orbitdb/</code> folder. This is good.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls orbitdb/</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">QmNrPunxswb2Chmv295GeCvK9FDusWaTr1ZrYhvWV9AtGM/</span>  zdpuB3VvBJHqYCocN4utQrpBseHou88mq2DLh7bUkWviBQSE3/</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls orbitdb/zdpuB3VvBJHqYCocN4utQrpBseHou88mq2DLh7bUkWviBQSE3/</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">pieces/</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls orbitdb/zdpuB3VvBJHqYCocN4utQrpBseHou88mq2DLh7bUkWviBQSE3/pieces/</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="ex">000003.log</span>  CURRENT  LOCK  LOG  MANIFEST-000002</span></code></pre></div>
<p>You do not need to understand this fully for now, just know that it happened. Two subfolders, one being the original folder you saw when you instantiated OrbitDB, and now another that has the same address as your database.</p>
<h5 id="what-else-happened-in-the-browser-1">What else happened in the browser?</h5>
<p>Similarly, a new IndexedDB database was created to hold your OrbitDB-specific info, apart from the data itself which are still stored in IPFS.</p>
<figure>
<img src="../images/ipfs_browser_2.png" alt="An image showing the IPFS and OrbitDB IndexedDB databases in Firefox" /><figcaption aria-hidden="true">An image showing the IPFS and OrbitDB IndexedDB databases in Firefox</figcaption>
</figure>
<p>This shows you one of OrbitDB’s core strengths - the ability to manage a lot of complexity between its own internals and those of IPFS, providing a clear and clean API to manage the data that matters to you.</p>
<h3 id="choosing-a-datastore">Choosing a datastore</h3>
<p>OrbitDB organizes its functionality by separating different data management concerns, schemas and APIs into <strong>stores</strong>. We chose a <code>docstore</code> for you in the last chapter, but after this tutorial it will be your job to determine the right store for the job.</p>
<p>Each OrbitDB store has its own specific API methods to create, delete, retrieve and update data. In general, you can expect to always have something like a <code>get</code> and something like a <code>put</code>.</p>
<p>You have the following choices:</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="header">
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong><a href="https://github.com/orbitdb/orbit-db/blob/master/API.md#orbitdblognameaddress">log</a></strong></td>
<td>An <em>immutable</em> (append-only) log with traversable history. Useful for <em>“latest N”</em> use cases or as a message queue.</td>
</tr>
<tr class="even">
<td><strong><a href="https://github.com/orbitdb/orbit-db/blob/master/API.md#orbitdbfeednameaddress">feed</a></strong></td>
<td>A <em>mutable</em> log with traversable history. Entries can be added and removed. Useful for <em>“shopping cart”</em> type of use cases, or for example as a feed of blog posts or “tweets”.</td>
</tr>
<tr class="odd">
<td><strong><a href="https://github.com/orbitdb/orbit-db/blob/master/API.md#orbitdbkeyvaluenameaddress">keyvalue</a></strong></td>
<td>A simple key-value database that supports any JSON-serializable data, even nested objects.</td>
</tr>
<tr class="even">
<td><strong><a href="https://github.com/orbitdb/orbit-db/blob/master/API.md#orbitdbdocsnameaddress-options">docs</a></strong></td>
<td>A document database that stores JSON documents which can be indexed by a specified key. Useful for building search indices or version controlling documents and data.</td>
</tr>
<tr class="odd">
<td><strong><a href="https://github.com/orbitdb/orbit-db/blob/master/API.md#orbitdbcounternameaddress">counter</a></strong></td>
<td>An increment-only integer counter useful for counting events separate from log/feed data.</td>
</tr>
</tbody>
</table>
<p>Also, OrbitDB developers can write their own stores if it suits them. This is an advanced topic and is covered in Part 3 of this book.</p>
<h3 id="key-takeaways">Key takeaways</h3>
<ul>
<li>OrbitDB is a distributed database layer which stores its raw data in IPFS</li>
<li>Both IPFS and OrbitDB work offline and online</li>
<li>OrbitDB instances have an <em>ID</em> which is the same as the underlying IPFS node’s ID.</li>
<li>OrbitDB instances create databases which have unique <em>addresses</em></li>
<li>Basic access rights to OrbitDB databases are managed using access control lists (or ACLs), based on the ID of the IPFS node performing the requests on the database</li>
<li>OrbitDB database addresses are hashes of the database’s ACL, its type, and its name.</li>
<li>Since OrbitDB and IPFS are written in JavaScript, it is possible to build isomorphic applications that run in the browser and in Node.js</li>
<li>OrbitDB manages needed flexibility of schema and API design in functionality called <strong>stores</strong>.</li>
<li>OrbitDB comes with a handful of stores, and you can write your own.</li>
<li>Each store will have its own API, but you will generally have at least a <code>get</code> and a <code>put</code></li>
</ul>
<p><strong>Now that you have laid the groundwork, you will learn how to work with data! Onward then, to <a href="./02_Managing_Data.md">Chapter 2: Managing Data</a>.</strong></p>
<ul>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/367">367</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/366">366</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/502">502</a></li>
</ul>
<h2 id="chapter-2---managing-data">Chapter 2 - Managing Data</h2>
<blockquote>
<p>Managing data in OrbitDB involves <em>loading databases into memory</em> and then <em>creating</em>, <em>updating</em>, <em>reading</em>, and <em>deleting data</em>.</p>
</blockquote>
<div>
<h3>
Table of Contents
</h3>
<p>Please complete <a href="./01_Basics.md">Chapter 1 - Laying the Foundation</a> first.</p>
<ul>
<li><a href="#loading-the-database">Loading the database</a></li>
<li><a href="#adding-data">Adding data</a></li>
<li><a href="#reading-data">Reading data</a></li>
<li><a href="#updating-and-deleting-data">Updating and deleting data</a></li>
<li><a href="#storing-media-files">Storing media files</a></li>
<li><a href="#key-takeaways">Key takeaways</a></li>
</ul>
</div>
<h3 id="loading-the-database">Loading the database</h3>
<p>The first thing your users will want is to make sure that when they load the app, their data is available. You will do so easily by loading the database contents into memory.</p>
<p>Update your <code>NewPiecePlease class</code> handler, adding <strong>one line</strong> at the bottom of the IPFS <code>ready</code> handler:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>  async _init () {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    this.orbitdb = await OrbitDB.createInstance(this.node)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    this.defaultOptions = { accessController: { write: [this.orbitdb.identity.id] }}</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    const docStoreOptions = {</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>      ...this.defaultOptions,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>      indexBy: &#39;hash&#39;,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    this.pieces = await this.orbitdb.docstore(&#39;pieces&#39;, docStoreOptions)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="va">+   await this.pieces.load()</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    this.onready()</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="what-just-happened-3">What just happened?</h4>
<p>After you instantiated the database you loaded its contents into memory for use. It is empty for now, but not for long! Loading the database at this point after instantiation will save you trouble later.</p>
<ul>
<li><code>await pieces.load()</code> is a function that will need to be called whenever we want the latest and greatest snapshot of data in the database. The <code>load</code> function retrieves all of the values via their <em>content addresses</em> and loads the content into memory.</li>
</ul>
<blockquote>
<p><strong>Note:</strong> You are probably wondering about if you have a large database of millions of documents, and the implications of loading them all into memory. It is a valid concern, and you should move on to Part 4 of this book once you are done with the tutorial.</p>
</blockquote>
<h3 id="adding-data">Adding data</h3>
<p>Next, your users will want to be able to add sheet music to their catalog. You will use functions exposed from OrbitDB’s <code>keyvalue</code> store now.</p>
<p>Add a function called <code>addNewPiece</code> function now, with some commented out functions we’ll use later.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ async addNewPiece(hash, instrument = &#39;Piano&#39;) {</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   // const existingPiece = this.getPieceByHash(hash)</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   if (existingPiece) {</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="va">+     // await this.updatePieceByHash(hash, instrument)</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="va">+     return</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="va">+   }</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="va">+   const cid = await this.pieces.put({ hash, instrument })</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="va">+   return cid</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>We have uploaded and pinned a few piano scores to IPFS, and will provide the hashes. You can add these hashes to your database by fleshing out and using the <code>addNewPiece</code> function.</p>
<p>In your application code, Node.js or browser, you can use this function like so, utilizing the default value for the <code>instrument</code> argument.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cid <span class="op">=</span> <span class="cf">await</span> NPP<span class="op">.</span><span class="fu">addNewPiece</span>(<span class="st">&quot;QmNR2n4zywCV61MeMLB6JwPueAPqheqpfiA4fLPMxouEmQ&quot;</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> content <span class="op">=</span> <span class="cf">await</span> NPP<span class="op">.</span><span class="at">node</span><span class="op">.</span><span class="at">dag</span><span class="op">.</span><span class="fu">get</span>(cid)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(content<span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="at">payload</span>)</span></code></pre></div>
<p>Running this code should give you something like the following output. Hold steady, it is overwhelming but it will make sense after we explain what happened. For more information see Part 3, The Architecture of OrbitDB.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;op&quot;</span><span class="fu">:</span><span class="st">&quot;PUT&quot;</span><span class="fu">,</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;key&quot;</span><span class="fu">:</span><span class="st">&quot;QmNR2n4zywCV61MeMLB6JwPueAPqheqpfiA4fLPMxouEmQ&quot;</span><span class="fu">,</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;hash&quot;</span><span class="fu">:</span><span class="st">&quot;QmNR2n4zywCV61MeMLB6JwPueAPqheqpfiA4fLPMxouEmQ&quot;</span><span class="fu">,</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;instrument&quot;</span><span class="fu">:</span><span class="st">&quot;Accordion&quot;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<blockquote>
<p><strong>Note:</strong> We hope you like the original Metroid NES game, or at least the music from it! All music Copyright © Nintendo.</p>
</blockquote>
<h4 id="what-just-happened-4">What just happened?</h4>
<p>You wrote and tested a function that allows users to add new sheet music to the database.</p>
<ul>
<li><code>pieces.put({ ... })</code> is the most important line here. This call takes an object to store and returns a <em>multihash</em>, which is the hash of the content added to IPFS.</li>
<li><code>node.dag.get(hash)</code> is a function that takes a CID and returns content.</li>
<li><code>"op": "PUT"</code> is a notable part of the output. At the core of OrbitDB databases is the <strong>OPLOG</strong>, where all data are stored as a log of operations, which are then calculated into the appropriate schema for application use. The operation is specified here as a <code>PUT</code>, and the <code>key</code>/<code>value</code> pair is your data.</li>
</ul>
<blockquote>
<p><strong>Note:</strong> “dag” in the code refers to the acronym DAG, which stands for Directed Acyclic Graph. This is a data structure that is closely related to blockchain.</p>
</blockquote>
<p>You can repeat this process to add more hashes from the NES Metroid soundtrack:</p>
<pre class="plain"><code>QmNR2n4zywCV61MeMLB6JwPueAPqheqpfiA4fLPMxouEmQ | Metroid - Ending Theme.pdf
QmRn99VSCVdC693F6H4zeS7Dz3UmaiBiSYDf6zCEYrWynq | Metroid - Escape Theme.pdf
QmdzDacgJ9EQF9Z8G3L1fzFwiEu255Nm5WiCey9ntrDPSL | Metroid - Game Start.pdf
QmcFUvG75QTMok9jrteJzBUXeoamJsuRseNuDRupDhFwA2 | Metroid - Item Found.pdf
QmTjszMGLb5gKWAhFZbo8b5LbhCGJkgS8SeeEYq3P54Vih | Metroid - Kraids Hideout.pdf
QmNfQhx3WvJRLMnKP5SucMRXEPy9YQ3V1q9dDWNC6QYMS3 | Metroid - Norfair.pdf
QmQS4QNi8DCceGzKjfmbBhLTRExNboQ8opUd988SLEtZpW | Metroid - Ridleys Hideout.pdf
QmcJPfExkBAZe8AVGfYHR7Wx4EW1Btjd5MXX8EnHCkrq54 | Metroid - Silence.pdf
Qmb1iNM1cXW6e11srUvS9iBiGX4Aw5dycGGGDPTobYfFBr | Metroid - Title Theme.pdf
QmYPpj6XVNPPYgwvN4iVaxZLHy982TPkSAxBf2rzGHDach | Metroid - Tourian.pdf
QmefKrBYeL58qyVAaJoGHXXEgYgsJrxo763gRRqzYHdL6o | Metroid - Zebetite.pdf</code></pre>
<p>These are all stored in the global IPFS network so you can find any piece by visiting a public gateway such as <code>ipfs.io</code> and adding the IPFS multiaddress to the end of the URL like so: <a href="https://ipfs.io/ipfs/QmYPpj6XVNPPYgwvN4iVaxZLHy982TPkSAxBf2rzGHDach">https://ipfs.io/ipfs/QmYPpj6XVNPPYgwvN4iVaxZLHy982TPkSAxBf2rzGHDach</a></p>
<h3 id="reading-data">Reading data</h3>
<p>Of course, your users will want to read their data after creating it, so you will enable that functionality now. OrbitDB gives you a number of ways to do this, mostly based on which <em>store</em> you picked.</p>
<p>We gave you a <code>docstore</code> earlier, so you can write some simple <code>get*</code> functions like so. <code>docstore</code> also provides the more powerful <code>query</code> function, which we can abstract to write a <code>getPiecesByInstrument</code> function:</p>
<p>Fill in the following functions now:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ getAllPieces() {</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const pieces = this.pieces.get(&#39;&#39;)</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   return pieces</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ getPieceByHash(hash) {</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const singlePiece = this.pieces.get(hash)[0]</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   return singlePiece</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ getPieceByInstrument(instrument) {</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   return this.pieces.query((piece) =&gt; piece.instrument === instrument)</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>and uncomment them from <code>addNewPiece</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ async addNewPiece(hash, instrument = &#39;Piano&#39;) {</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="st">-   // const existingPiece = this.getPieceByHash(hash)</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   const existingPiece = this.getPieceByHash(hash)</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="va">+   if (existingPiece) {</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="st">-     // await this.updatePieceByHash(hash, instrument)</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="va">+     await this.updatePieceByHash(hash, instrument)</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="va">+     return</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="va">+   }</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="va">+   const cid = await this.pieces.put({ hash, instrument })</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="va">+   return cid</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>In your application code, you can use these functions like so:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>pieces <span class="op">=</span> NPP<span class="op">.</span><span class="fu">getAllPieces</span>()</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>pieces<span class="op">.</span><span class="fu">forEach</span>((piece) <span class="kw">=&gt;</span> { <span class="co">/* do something */</span> })</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>piece <span class="op">=</span> NPP<span class="op">.</span><span class="fu">getPieceByHash</span>(<span class="st">&#39;QmNR2n4zywCV61MeMLB6JwPueAPqtheqpfiA4fLPMxouEmQ&#39;</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(piece)</span></code></pre></div>
<p>Pulling a random score from the database is a great way to find random music to practice. Run this code:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pieces <span class="op">=</span> NPP<span class="op">.</span><span class="fu">getPieceByInstrument</span>(<span class="st">&quot;Piano&quot;</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> randomPiece <span class="op">=</span> pieces[pieces<span class="op">.</span><span class="at">length</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">|</span> <span class="dv">0</span>]</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(randomPiece)</span></code></pre></div>
<p>Both <code>console.log</code> calls above will return something like this:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;hash&quot;</span><span class="fu">:</span><span class="st">&quot;QmNR2n4zywCV61MeMLB6JwPueAPqheqpfiA4fLPMxouEmQ&quot;</span><span class="fu">,</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;instrument&quot;</span><span class="fu">:</span><span class="st">&quot;Accordion&quot;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="what-just-happened-5">What just happened?</h4>
<p>You queried the database of scores you created earlier in the chapter, retrieving by hash and also randomly.</p>
<ul>
<li><code>pieces.get(hash)</code> is a simple function that performs a partial string search on your database indexes. It will return an array of records that match. As you can see in your <code>getAllPieces</code> function, you can pass an empty string to return all pieces.</li>
<li><code>return this.pieces.query((piece) =&gt; piece.instrument === instrument)</code> queries the database, returning. It’s most analogous to JavaScripts <code>Array.filter</code> method.</li>
</ul>
<blockquote>
<p><strong>Note:</strong> Generally speaking, <code>get</code> functions do not return promises since the calculation of database state happens at the time of a <em>write</em>. This is a trade-off to allow for ease of use and performance based on the assumption that writes are <em>generally</em> less frequent than reads.</p>
</blockquote>
<h3 id="updating-and-deleting-data">Updating and deleting data</h3>
<p>Next, you will want to provide your users with the ability to update and delete their pieces. For example, if you realize you would rather practice a piece on a harpsichord instead of a piano, or if they want to stop practicing a certain piece.</p>
<p>Again, each OrbitDB store may have slightly different methods for this. In the <code>docstore</code> you can update records by again using the <code>put</code> method and the ID of the index you want to update.</p>
<p>Fill in the <code>updatePieceByHash</code> and <code>deletePieceByHash</code> functions now:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ async updatePieceByHash (hash, instrument = &#39;Piano&#39;) {</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const piece = await this.getPieceByHash(hash)</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   piece.instrument = instrument</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="va">+   const cid = await this.pieces.put(piece)</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="va">+   return cid</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ async deletePieceByHash (hash) {</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const cid = await this.pieces.del(hash)</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   return cid</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>In your application code, you can run these new functions and see the opcodes that return to get a sense of what is going on.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cid <span class="op">=</span> <span class="cf">await</span> NPP<span class="op">.</span><span class="fu">updatePiece</span>(<span class="st">&quot;QmNR2n4zywCV61MeMLB6JwPueAPqheqpfiA4fLPMxouEmQ&quot;</span><span class="op">,</span> <span class="st">&quot;Harpsichord&quot;</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co">// do stuff with the cid as above</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cid <span class="op">=</span> <span class="cf">await</span> NPP<span class="op">.</span><span class="fu">deletePieceByHash</span>(<span class="st">&quot;QmNR2n4zywCV61MeMLB6JwPueAPqheqpfiA4fLPMxouEmQ&quot;</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> content <span class="op">=</span> <span class="cf">await</span> NPP<span class="op">.</span><span class="at">node</span><span class="op">.</span><span class="at">dag</span><span class="op">.</span><span class="fu">get</span>(cid)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(content<span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="at">payload</span>)</span></code></pre></div>
<p>While the opcode for PUT will be the same, the opcode for <code>deletePieceByHash</code> is not:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;op&quot;</span><span class="fu">:</span><span class="st">&quot;DEL&quot;</span><span class="fu">,</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;key&quot;</span><span class="fu">:</span><span class="st">&quot;QmdzDacgJ9EQF9Z8G3L1fzFwiEu255Nm5WiCey9ntrDPSL&quot;</span><span class="fu">,</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span><span class="kw">null</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="what-just-happened-6">What just happened?</h4>
<p>You may be thinking something like this: “Wait, if OrbitDB is built upon IPFS and IPFS is immutable, then how are we updating or deleting records?” Great question, and the answer lies in the opcodes Let us step through the code so we can get to that.</p>
<ul>
<li><code>this.pieces.put</code> is nothing new, we are just using it to perform an update instead of an insert</li>
<li><code>this.pieces.del</code> is a simple function that takes a hash, deletes the record, and returns a CID</li>
<li><code>"op": "DEL"</code> is another opcode, <code>DEL</code> for DELETE. This log entry effectively removes this key from your records and also removes the content from your local IPFS</li>
</ul>
<h3 id="storing-media-files">Storing Media Files</h3>
<p>Your users will probably not want to mess with content hashes, so you will want to provide them the ability to add files directly to IPFS. This section shows how you will be able to do this, and then store the <em>address</em> of the file in OrbitDB.</p>
<p>The overall pattern is:</p>
<ol type="1">
<li>Add the file to IPFS, which will return the <em>multihash</em> of the file</li>
<li>Store said multihash in OrbitDB</li>
<li>When it comes time to display the media, use native IPFS functionality to retrieve it from the hash</li>
</ol>
<h4 id="adding-content-to-ipfs">Adding content to IPFS</h4>
<p>To see this in action, <a href="https://ipfs.io/ipfs/QmYPpj6XVNPPYgwvN4iVaxZLHy982TPkSAxBf2rzGHDach">download the “Tourian” PDF</a> to your local file system for use in the next examples</p>
<h5 id="on-the-command-line-with-the-go-ipfs-or-js-ipfs-daemon">On the command line with the go-ipfs or js-ipfs daemon</h5>
<p>After following the installation instructions to install <a href="https://github.com/ipfs/go-ipfs">go-ipfs</a> or <a href="https://github.com/ipfs/js-ipfs">js-ipfs</a> globally, you can run the following command:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ipfs add file.pdf</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">QmYPpj6XVNPPYgwvN4iVaxZLHy982TPkSAxBf2rzGHDach</span></span></code></pre></div>
<p>You can then use that hash in the same manner as above to add it to the database of pieces.</p>
<h5 id="in-node.js-1">In Node.js</h5>
<p>In Node.js, adding a file from the filesystem can be accomplished like so:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> IPFS <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;ipfs&#39;</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ipfs <span class="op">=</span> <span class="kw">new</span> <span class="fu">IPFS</span>(<span class="co">/* insert appropriate options here for your local IPFS installation */</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>ipfs<span class="op">.</span><span class="fu">addFromFs</span>(<span class="st">&quot;./file.pdf&quot;</span>)<span class="op">.</span><span class="fu">then</span>(<span class="bu">console</span><span class="op">.</span><span class="fu">log</span>)</span></code></pre></div>
<h5 id="in-the-browser-1">In the browser</h5>
<p>If you have a HTML file input with an ID of “fileUpload”, you can do something like the following to add content to IPFS:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&quot;fileUpload&quot;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;change&#39;</span><span class="op">,</span> <span class="kw">async</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> file <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">files</span>[<span class="dv">0</span>]</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (file) {</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> NPP<span class="op">.</span><span class="at">node</span><span class="op">.</span><span class="fu">add</span>(file)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cid <span class="op">=</span> <span class="cf">await</span> NPP<span class="op">.</span><span class="fu">addNewPiece</span>(result[<span class="dv">0</span>]<span class="op">.</span><span class="at">hash</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Note that there are still issues with swarming in the browser, so you may have trouble discovering content. Stay tuned for future <code>js-ipfs</code> releases to fix this.</p>
<h4 id="what-just-happened-7">What just happened?</h4>
<p>You added some potentially very large media files to IPFS, and then stored the 40-byte addresses in OrbitDB for retrieval and use. You are now able to leverage the benefits of both IPFS and OrbitDB in both the browser and Node.js.</p>
<blockquote>
<p><strong>Note:</strong> IPFS nodes run <em>inside</em> the browser, so if you’re adding lots of files via the above method, keep an eye on your IndexedDB quotas, since that’s where IPFS is storing the blocks.</p>
</blockquote>
<h3 id="key-takeaways-1">Key takeaways</h3>
<ul>
<li>Calling <code>load()</code> periodically ensures you have the latest entries from a local database available in memory</li>
<li>Generally speaking, a <code>put</code> or <code>delete</code> will return a Promise (or require <code>await</code>), and a <code>get</code> will return the value(s) immediately.</li>
<li>Updating the database is equivalent to adding a new entry to its OPLOG.</li>
<li>The OPLOG is calculated to give the current <em>state</em> of the database, which is the view you generally interact with</li>
<li>OPLOGS are flexible, particularly if you’re writing your own stores. <code>docstore</code> primarily utilizes the <code>PUT</code> and <code>DEL</code> opcodes</li>
<li>While you technically <em>can</em> store encoded media directly in a database, media files are best stored in OrbitDB as IPFS hashes</li>
<li>Keep an eye on IndexedDB size and limitations when adding content to IPFS via the browser.</li>
</ul>
<p><strong>Of course, in the vast majority of apps you create, you won’t just be interacting with one database or one type of data. We’ve got you covered in <a href="03_Structuring_Data.md">Chapter 3: Structuring Data</a></strong></p>
<ul>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/365">365</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/438">438</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/381">381</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/242">242</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/430">430</a></li>
</ul>
<h2 id="chapter-3---structuring-your-data">Chapter 3 - Structuring your data</h2>
<blockquote>
<p>or, “How you learned to stop worrying and love <em>nested databases</em>.”</p>
</blockquote>
<div>
<h3>
Table of Contents
</h3>
<p>Please complete <a href="./02_Managing_Data.md">Chapter 2 - Managing Data</a> first.</p>
<ul>
<li><a href="#adding-a-practice-counter-to-each-piece">Adding a practice counter to each piece</a></li>
<li><a href="#utilizing-your-practice-counter">Utilizing your practice counter</a></li>
<li><a href="#adding-a-higher-level-user-database">Adding a higher-level user database</a></li>
<li><a href="#dealing-with-fixture-data">Dealing with fixture data</a></li>
<li><a href="#key-takeaways">Key takeaways</a></li>
</ul>
</div>
<h3 id="adding-a-practice-counter-to-each-piece">Adding a practice counter to each piece</h3>
<p>Your users may want to keep track of their practice, at minimum how many times they practiced a piece. You will enable that functionality for them by creating a new OrbitDB <code>counter</code> store for each piece, and creating a few new functions inside the <code>NewPiecePlease</code> class to interact with the counters.</p>
<blockquote>
<p><strong>Note:</strong> The nesting approach detailed here is but one of many, and you are free to organize your data as you see fit. This is a powerful feature of OrbitDB and we are excited to see how people tackle this problem in the future!</p>
</blockquote>
<p>Update the <code>addNewPiece</code> function to create a <code>counter</code> store every time a new piece is added to the database. You can utilize basic access control again to ensure that only a node with your IPFS node’s ID can write to it.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>async addNewPiece (hash, instrument = &#39;Piano&#39;) {</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  const existingPiece = this.pieces.get(hash)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  if(existingPiece) {</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    await this.updatePieceByHash(hash, instrument)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    return;</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="va">+ const dbName = &#39;counter.&#39; + hash.substr(20,20)</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="va">+ const counter = await this.orbitdb.counter(dbName, this.defaultOptions)</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  const cid = await this.pieces.put({ hash, instrument,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="va">+   counter: counter.id</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  return cid</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>In your application code this would look something like this:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cid <span class="op">=</span> <span class="cf">await</span> NPP<span class="op">.</span><span class="fu">addNewPiece</span>(<span class="st">&#39;QmdzDacgJ9EQF9Z8G3L1fzFwiEu255Nm5WiCey9ntrDPSL&#39;</span><span class="op">,</span> <span class="st">&#39;Piano&#39;</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> content <span class="op">=</span> <span class="cf">await</span> NPP<span class="op">.</span><span class="at">node</span><span class="op">.</span><span class="at">dag</span><span class="op">.</span><span class="fu">get</span>(cid)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(content<span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="at">payload</span><span class="op">.</span><span class="at">value</span>)</span></code></pre></div>
<p>Which will then output something like:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;hash&quot;</span><span class="fu">:</span><span class="st">&quot;QmdzDacgJ9EQF9Z8G3L1fzFwiEu255Nm5WiCey9ntrDPSL&quot;</span><span class="fu">,</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;counter&quot;</span><span class="fu">:</span><span class="st">&quot;/orbitdb/zdpuAoM3yZEwsynUgeWPfizmWz5DEFPiQSvg5gUPu9VoGhxjS/counter.fzFwiEu255Nm5WiCey9n&quot;</span><span class="fu">,</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;instrument&quot;</span><span class="fu">:</span><span class="st">&quot;Piano&quot;</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="what-just-happened-8">What just happened?</h4>
<p>You changed your code to add a new database of type <code>counter</code> for each new entry added to the database.</p>
<ul>
<li><code>const options = { accessController: { write: [this.orbitdb.identity.id] }}</code> should be recognizable from Chapter 1. This sets options for the db, namely the <code>accessController</code> to give write access only to your node’s ID.</li>
<li><code>this.orbitdb.counter</code> creates a new counter type with <code>options</code> that provide a write ACL for your IPFS node</li>
<li><code>const dbName = "counter." + hash.substr(20,20)</code> prepends <code>counter.</code> to the truncated database name. See the note below.</li>
<li><code>this.pieces.put</code> is then modified to store the <em>address</em> of this new database for later retrieval similar to the way you stored media addresses in a previous chapter.</li>
<li><code>"counter":"/orbitdb/zdpuAoM3yZEwsynUgeWPfizmWz5DEFPiQSvg5gUPu9VoGhxjS/counter.fzFwiEu255Nm5WiCey9n"</code> in the output now reflects this change by storing the <em>address</em> of the new DB for later retrieval and updating.</li>
</ul>
<blockquote>
<p><strong>Note:</strong> There is a limit of 40 characters on the names of the databases, and multihashes are over this limit at 46. We still need unique names for each of the databases created to generate unique addresses, so we trim down the hash and prepend it with <code>counter.</code> to get around this limitation.</p>
</blockquote>
<h3 id="utilizing-the-practice-counter">Utilizing the practice counter</h3>
<p>Now, add a few functions to <code>NewPiecePlease</code> that utilize the counters when necessary</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ async getPracticeCount (piece) {</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const counter = await this.orbitdb.counter(piece.counter)</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   await counter.load()</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="va">+   return counter.value</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="va">+ async incrementPracticeCounter (piece) {</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="va">+   const counter = await this.orbitdb.counter(piece.counter)</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="va">+   const cid = await counter.inc()</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="va">+   return cid</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>These can be used in your application code like so:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> piece <span class="op">=</span> NPP<span class="op">.</span><span class="fu">getPieceByHash</span>(<span class="st">&#39;QmdzDacgJ9EQF9Z8G3L1fzFwiEu255Nm5WiCey9ntrDPSL&#39;</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cid <span class="op">=</span> <span class="cf">await</span> NPP<span class="op">.</span><span class="fu">incrementPracticeCounter</span>(piece)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> content <span class="op">=</span> <span class="cf">await</span> NPP<span class="op">.</span><span class="at">node</span><span class="op">.</span><span class="at">dag</span><span class="op">.</span><span class="fu">get</span>(cid)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(content<span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="at">payload</span>)</span></code></pre></div>
<p>That will <code>console.log</code> out something like:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;op&quot;</span><span class="fu">:</span><span class="st">&quot;COUNTER&quot;</span><span class="fu">,</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;key&quot;</span><span class="fu">:</span><span class="kw">null</span><span class="fu">,</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span><span class="st">&quot;042985dafe18ba45c7f1a57db.........02ae4b5e4aa3eb36bc5e67198c2d2&quot;</span><span class="fu">,</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;counters&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;042985dafe18ba45c7f1a57db.........02ae4b5e4aa3eb36bc5e67198c2d2&quot;</span><span class="fu">:</span><span class="dv">3</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="what-just-happened-9">What just happened?</h4>
<p>You created and used two new functions to both read the value of, and increment a <code>counter</code>, another type of OrbitDB store.</p>
<ul>
<li><code>await this.orbitdb.counter(piece.counter)</code> is a new way of using <code>this.orbitdb.counter</code>, by passing in an existing database address. This will <em>open</em> the existing database instead of creating it</li>
<li><code>counter.load()</code> is called once in <code>getPracticeCount</code>, loading the latest database entries into memory for display</li>
<li><code>await counter.inc()</code> increments the counter, like calling <code>counter++</code> would on an integer variable</li>
<li><code>"op":"COUNTER"</code> is a new operation that you haven’t seen yet - remember, you can create stores with any operations you want. More on this in Part 3.</li>
<li><code>"counters": { "042985dafe18ba45c7f1a57db.........02ae4b5e4aa3eb36bc5e67198c2d2": 3 }</code> is the value returned, the long value is an id based on your node’s public key</li>
</ul>
<h3 id="adding-a-higher-level-database-for-user-data">Adding a higher-level database for user data</h3>
<p>Pieces of music to practice with are great to have, but moving forward you will want to allow users to further express themselves via a username and a profile. You will create a new database for users, from which your database of pieces will be referenced. This will also help prepare you for allowing users to connect to each other in the next chapter.</p>
<p>Update your <code>_init</code> function to look like this:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>  async _init() {</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    this.orbitdb = await OrbitDB.createInstance(this.node)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    this.defaultOptions = { write: [this.orbitdb.identity.id] }</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    const docStoreOptions = {</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>      ...this.defaultOptions,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>      indexBy: &#39;hash&#39;,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    this.pieces = await this.orbitdb.docstore(&#39;pieces&#39;, docStoreOptions)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    await this.pieces.load()</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="va">+   this.user = await this.orbitdb.kvstore(&#39;user&#39;, this.defaultOptions)</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="va">+   await this.user.load()</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="va">+   await this.user.set(&#39;pieces&#39;, this.pieces.id)</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    this.onready()</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  });</span></code></pre></div>
<p>Then add the following functions in your class:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ async deleteProfileField (key) {</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const cid = await this.user.del(key)</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   return cid</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="va">+ getAllProfileFields () {</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="va">+   return this.user.all;</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="va">+ getProfileField (key) {</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="va">+   return this.user.get(key)</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="va">+ async updateProfileField (key, value) {</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="va">+   const cid = await this.user.set(key, value)</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="va">+   return cid</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>In your application code, you can use them like this:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> NPP<span class="op">.</span><span class="fu">updateProfileField</span>(<span class="st">&quot;username&quot;</span><span class="op">,</span> <span class="st">&quot;aphelionz&quot;</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> profileFields <span class="op">=</span> NPP<span class="op">.</span><span class="fu">getAllProfileFields</span>()</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co">// { &quot;username&quot;: &quot;aphelionz&quot;, &quot;pieces&quot;: &quot;/orbitdb/zdpu...../pieces&quot; }</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> NPP<span class="op">.</span><span class="fu">deleteProfileField</span>(<span class="st">&quot;username&quot;</span>)</span></code></pre></div>
<p>We think you’re getting the idea.</p>
<h4 id="what-just-happened-10">What just happened?</h4>
<p>You created a database to store anything and everything that might pertain to a user, and then linked the <code>pieces</code> to that, nested inside.</p>
<ul>
<li><code>this.orbitdb.kvstore('user', this.defaultOptions)</code> creates a new OrbitDB of a type that allows you to manage a simple key-value store.</li>
<li><code>this.user.set('pieces', this.pieces.id)</code> is the function that the <code>kvstore</code> uses to set items. This is equivalent to something like the shorthand <code>user = {}; user.pieces = id</code></li>
<li><code>this.user.all</code> contains all keys and values from a <code>keystore</code> database <strong>This is a property, not a function!</strong></li>
<li><code>this.user.del(key)</code> deletes the specified key and corresponding value from the store</li>
<li><code>this.user.get(key)</code> retrieves the specified key and the corresponding value from the store</li>
</ul>
<h3 id="dealing-with-fixture-data">Dealing with fixture data</h3>
<p>Fresh users to the app will need a strong onboarding experience, and you will enable that for them now by giving people some data to start with, and you will want this process to work offline.</p>
<p>First, create the <code>loadFixtureData</code> function inside the <code>NewPiecePlease</code> class:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ async loadFixtureData (fixtureData) {</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const fixtureKeys = Object.keys(fixtureData)</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   for (let i in fixtureKeys) {</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="va">+     let key = fixtureKeys[i]</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="va">+     if(!this.user.get(key)) await this.user.set(key, fixtureData[key])</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="va">+   }</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>Then, update your <em>init</em> function to call <code>loadFixtureData</code> with some starter data:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>  async _init() {</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const peerInfo = await this.node.id()</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    this.orbitdb = await OrbitDB.createInstance(this.node)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    this.defaultOptions = { accessController: { write: [this.orbitdb.identity.id] }}</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    const docStoreOptions = {</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>      ...this.defaultOptions,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>      indexBy: &#39;hash&#39;,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    this.pieces = await this.orbitdb.docstore(&#39;pieces&#39;, docStoreOptions)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    await this.pieces.load()</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    this.user = await this.orbitdb.kvstore(&#39;user&#39;, this.defaultOptions)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    await this.user.load()</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="va">+   await this.loadFixtureData({</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="va">+     &#39;username&#39;: Math.floor(Math.random() * 1000000),</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="va">+     &#39;pieces&#39;: this.pieces.id,</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="va">+     &#39;nodeId&#39;: peerInfo.id</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="va">+   })</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    this.onready()</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>Then, if you were to clear all local data and load the app from scratch, you would see this:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> profileFields <span class="op">=</span> NPP<span class="op">.</span><span class="fu">getAllProfileFields</span>()</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(profileFields)</span></code></pre></div>
<p>You would see:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;nodeId&quot;</span><span class="fu">:</span> <span class="st">&quot;QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM&quot;</span><span class="fu">,</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;pieces&quot;</span><span class="fu">:</span> <span class="st">&quot;/orbitdb/zdpuArXLduV6myTmAGR4WKv4T7yDDV7KvwkmBaU8faCdrKvw6/pieces&quot;</span><span class="fu">,</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;username&quot;</span><span class="fu">:</span> <span class="dv">304532</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="what-just-happened-11">What just happened?</h4>
<p>You created simple fixture data and a function to load it into a fresh instantiation of the app.</p>
<ul>
<li><code>for (let i in fixtureKeys)</code> - this type of for loop is used to ensure that the writes happen serially, one after another.</li>
<li><code>await this.user.set(key, fixtureData[key])</code> sets the user profile key to the fixture value, if the key does not exist</li>
<li><code>await this.node.id()</code> is a slight misnomer, as it provides a more generalized <code>peerInfo</code> object.</li>
<li><code>peerInfo.id</code> contains the ID string you want, the base58 hash of the IPFS id.</li>
</ul>
<h3 id="key-takeaways-2">Key takeaways</h3>
<ul>
<li>The distributed applications of the future will be complex and require data structures to mirror and manage that complexity.</li>
<li>Luckily, OrbitDB is extremely flexible when it comes to generating complex and linked data structures</li>
<li>These structures can contain any combination of OrbitDB stores - you are not limited to just one.</li>
<li>You can nest a database within another, and you can create new databases to nest your existing databases within.</li>
<li><em>Nesting</em> databases is a powerful approach, but it is one of many. <strong>Do not</strong> feel limited. <strong>Do</strong> share novel approaches with the community.</li>
<li>Fixture data can be loaded easily, and locally, by simply including a basic set of values during app initialization</li>
</ul>
<p><strong>And with this, you are now ready to connect to the outside world. Continue to <a href="04_P2P_Part_1.md">Chapter 4: Peer-to-Peer, Part 1</a> to join your app to the global IPFS network, and to other users!</strong></p>
<h2 id="chapter-4-peer-to-peer-part-1-the-ipfs-layer">Chapter 4: Peer-to-Peer, Part 1 (The IPFS Layer)</h2>
<blockquote>
<p>There’s a lot of ground to cover as we move from offline to fully peer-to-peer, and we need to start where it starts: <em>connecting to IPFS</em>, <em>connecting directly to peers</em>, and <em>communicating with them via IPFS pubsub.</em></p>
</blockquote>
<div>
<h3>
Table of Contents
</h3>
<p>Please complete <a href="./03_Structuring_Data.md">Chapter 3 - Structuring Data</a> first.</p>
<ul>
<li><a href="#connecting-to-the-global-ipfs-network">Connecting to the global IPFS network</a></li>
<li><a href="#getting-a-list-of-connected-peers">Getting a list of connected peers</a></li>
<li><a href="#manually-connecting-to-peers">Manually connecting to peers</a></li>
<li><a href="#peer-to-peer-communication-via-IPFS-pubsub">Peer to peer communication via IPFS pubsub</a></li>
<li><a href="#key-takeaways">Key takeaways</a></li>
</ul>
</div>
<h3 id="connecting-to-the-global-ipfs-network">Connecting to the global IPFS network</h3>
<p>Your users can manage their local sheet music library, but music is a social, connected venture. The app should reflect that! You will now reconfigure your IPFS node to connect to the global network and begin swarming with other peers. This tutorial started offline to focus on OrbitDB’s core concepts, and now you will undo this and connect the app, properly, to the global IPFS network.</p>
<p>To connect globally, the <code>NewPiecePlease</code> constructor like so:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>class NewPiecePlease {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  constructor (IPFS, OrbitDB) {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   this.IPFS = IPFS</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    this.node = new IPFS({</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="st">-     preload: { enabled: false }</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="va">+     relay: { enabled: true, hop: { enabled: true, active: true } },</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>      EXPERIMENTAL: { pubsub: true },</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>      repo: &#39;./ipfs&#39;,</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="st">-     config: {  Bootstrap: [], Addresses: { Swarm: [] } }</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    });</span></code></pre></div>
<p>Now, you can either delete your data, by deleting the <code>ipfs</code> and <code>orbitdb</code> folders in Node.js, or by clearing your local data in the browser, or you can restore locally. If you don’t mind doing this, you can skip ahead to <a href="#getting-a-list-of-connected-peers">Getting a list of connected peers</a>.</p>
<h4 id="restoring-default-ipfs-config-values">Restoring default IPFS config values</h4>
<p>If you don’t want to blow away your data, then you can manually restore the default values by running a few commands on the application layer.</p>
<h4 id="restoring-your-default-bootstrap-peers">Restoring your default bootstrap peers</h4>
<p>Bootstrap peers are peers that your node connects to automatically when it starts. IPFS supplies this list by default and is comprised of a decentralized set of public IPFS servers.</p>
<p>However, since we purposefully started with an empty list of bootstrap peers and they won’t be restored by simply removing the config values. This is because bootstrap and swarm values are persisted in your IPFS config. This is located in the filesystem in the case of Node.js and in IndexedDB in the case of the browser. You should not manually edit these files.</p>
<p>However, nothing will change yet when you run the app. To see this, run this command in a running application:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> NPP<span class="op">.</span><span class="at">node</span><span class="op">.</span><span class="at">bootstrap</span><span class="op">.</span><span class="fu">list</span>()</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co">// outputs []</span></span></code></pre></div>
<p>To restore the default peers, like the one generated in the previous chapters, run this command <em>once</em> to restore your default bootstrap peers.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">node</span><span class="op">.</span><span class="at">bootstrap</span><span class="op">.</span><span class="fu">reset</span>()</span></code></pre></div>
<p>Re-running <code>bootstrap.list</code> now gives you a colorful array of bootstrap peers, ready to be connected to.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> NPP<span class="op">.</span><span class="at">node</span><span class="op">.</span><span class="at">bootstrap</span><span class="op">.</span><span class="fu">list</span>()</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co">/* outputs:</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip4/104.236.176.52/tcp/4001/ipfs/QmSoLnSGccFuZQJzRadHn95W2CrSFmZuTdDWP8HXaHca9z&#39;,</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip4/104.131.131.82/tcp/4001/ipfs/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ&#39;,</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip4/104.236.179.241/tcp/4001/ipfs/QmSoLPppuBtQSGwKDZT2M73ULpjvfd3aZ6ha4oFGL1KrGM&#39;,</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip4/162.243.248.213/tcp/4001/ipfs/QmSoLueR4xBeUbY9WZ9xGUUxunbKWcrNFTDAadQJmocnWm&#39;,</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip4/128.199.219.111/tcp/4001/ipfs/QmSoLSafTMBsPKadTEgaXctDQVcqN88CNLHXMkTNwMKPnu&#39;,</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip4/104.236.76.40/tcp/4001/ipfs/QmSoLV4Bbm51jM9C4gDYZQ9Cy3U6aXMJDAbzgu2fzaDs64&#39;,</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip4/178.62.158.247/tcp/4001/ipfs/QmSoLer265NRgSp2LA3dPaeykiS1J6DifTC88f5uVQKNAd&#39;,</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip4/178.62.61.185/tcp/4001/ipfs/QmSoLMeWqB7YGVLJN3pNLQpmmEk35v6wYtsMGLzSr5QBU3&#39;,</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip4/104.236.151.122/tcp/4001/ipfs/QmSoLju6m7xTh3DuokvT3886QRYqxAzb1kShaanJgW36yx&#39;,</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip6/2604:a880:1:20::1f9:9001/tcp/4001/ipfs/QmSoLnSGccFuZQJzRadHn95W2CrSFmZuTdDWP8HXaHca9z&#39;,</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip6/2604:a880:1:20::203:d001/tcp/4001/ipfs/QmSoLPppuBtQSGwKDZT2M73ULpjvfd3aZ6ha4oFGL1KrGM&#39;,</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip6/2604:a880:0:1010::23:d001/tcp/4001/ipfs/QmSoLueR4xBeUbY9WZ9xGUUxunbKWcrNFTDAadQJmocnWm&#39;,</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip6/2400:6180:0:d0::151:6001/tcp/4001/ipfs/QmSoLSafTMBsPKadTEgaXctDQVcqN88CNLHXMkTNwMKPnu&#39;,</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip6/2604:a880:800:10::4a:5001/tcp/4001/ipfs/QmSoLV4Bbm51jM9C4gDYZQ9Cy3U6aXMJDAbzgu2fzaDs64&#39;,</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip6/2a03:b0c0:0:1010::23:1001/tcp/4001/ipfs/QmSoLer265NRgSp2LA3dPaeykiS1J6DifTC88f5uVQKNAd&#39;,</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip6/2a03:b0c0:1:d0::e7:1/tcp/4001/ipfs/QmSoLMeWqB7YGVLJN3pNLQpmmEk35v6wYtsMGLzSr5QBU3&#39;,</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/ip6/2604:a880:1:20::1d9:6001/tcp/4001/ipfs/QmSoLju6m7xTh3DuokvT3886QRYqxAzb1kShaanJgW36yx&#39;,</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/dns4/node0.preload.ipfs.io/tcp/443/wss/ipfs/QmZMxNdpMkewiVZLMRxaNxUeZpDUb34pWjZ1kZvsd16Zic&#39;,</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;/dns4/node1.preload.ipfs.io/tcp/443/wss/ipfs/Qmbut9Ywz9YEDrz8ySBSgWyJk41Uvm2QJPhwDJzJyGFsD6&#39;</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<h4 id="enabling-the-swarm">Enabling the swarm</h4>
<p>Next, you will restore your default swarm addresses. These are addresses that your node announces itself to the world on.</p>
<p>Luckily, in the browser you don’t have to do anything, the default is an empty array. You should already see something like this in your console:</p>
<pre class="plain"><code>Swarm listening on /p2p-circuit/ipfs/QmWxWkrCcgNBG2uf1HSVAwb9RzcSYYC2d6CRsfJcqrz2FX
Swarm listening on /p2p-circuit/p2p-websocket-star/ipfs/QmWxWkrCcgNBG2uf1HSVAwb9RzcSYYC2d6CRsfJcqrz2FX</code></pre>
<p>In Node.js, run this command:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>NPP<span class="op">.</span><span class="at">node</span><span class="op">.</span><span class="at">config</span><span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;Addresses.Swarm&#39;</span><span class="op">,</span> [<span class="st">&#39;/ip4/0.0.0.0/tcp/4002&#39;</span><span class="op">,</span> <span class="st">&#39;/ip4/127.0.0.1/tcp/4003/ws&#39;</span>]<span class="op">,</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>)</span></code></pre></div>
<p>After restarting your app you will see the console output confirming you’re swarming. In Node.js you will see something like:</p>
<pre class="plain"><code>Swarm listening on /p2p-websocket-star/ipfs/QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM
Swarm listening on /ip4/127.0.0.1/tcp/4002/ipfs/QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM
Swarm listening on /ip4/172.16.100.191/tcp/4002/ipfs/QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM
Swarm listening on /ip4/172.17.0.1/tcp/4002/ipfs/QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM
Swarm listening on /ip4/127.0.0.1/tcp/4003/ws/ipfs/QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM
Swarm listening on /p2p-circuit/ipfs/QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM
Swarm listening on /p2p-circuit/p2p-websocket-star/ipfs/QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM
Swarm listening on /p2p-circuit/ip4/127.0.0.1/tcp/4002/ipfs/QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM
Swarm listening on /p2p-circuit/ip4/172.16.100.191/tcp/4002/ipfs/QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM
Swarm listening on /p2p-circuit/ip4/172.17.0.1/tcp/4002/ipfs/QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM
Swarm listening on /p2p-circuit/ip4/127.0.0.1/tcp/4003/ws/ipfs/QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM</code></pre>
<p>You can get the addresses that your node is publishing on via the following command:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> id <span class="op">=</span> <span class="cf">await</span> NPP<span class="op">.</span><span class="at">node</span><span class="op">.</span><span class="fu">id</span>()</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(id<span class="op">.</span><span class="at">addresses</span>)</span></code></pre></div>
<p>You will see a list of addresses your node is publishing on. Expect the browser to have only 2, and Node.js to have more. Since we’re dealing with both Node.js and the browser, we’ll focus on the addresses starting with <code>p2p-circuit</code>.</p>
<h4 id="what-just-happened-12">What just happened?</h4>
<p>Before this, you were working offline. Now you’re not. You’ve been connected to the global IPFS network and are ready for peer to-peer connections.</p>
<ul>
<li>Removing <code>preload: { enabled: false }</code> enables connection to the bottom two nodes from the above bootstrap list.</li>
<li>Removing <code>config: {  Bootstrap: [], Addresses: { Swarm: [] } }</code> will prevent the storing of empty arrays in your config files for the <code>Bootstrap</code> and <code>Addresses.Swarm</code> config keys</li>
<li><code>this.node.bootstrap.add(undefined, { default: true })</code> restores the default list of bootstrap peers, as seen above</li>
<li><code>NPP.node.config.set('Addresses.Swarm', ...</code> restores the default swarm addresses. You should have run this in Node.js only</li>
<li><code>relay: { enabled: true, hop: { enabled: true, active: true } }</code> sets up a your node as a “circuit relay”, which means that others will be able to “hop” through your node to connect to your peers, and your node will hop over others to do the same.</li>
</ul>
<p>Again, you won’t have to do either of these restorations if you’re starting with a fresh IPFS repo. These instructions are just included to deepen your understanding of what’s going on in the stack. We realize we’ve been spending a lot of time in IPFS config and IPFS commands - it’s understandable, since the IPFS features form the backbone of what we’re doing with OrbitDB.</p>
<blockquote>
<p><strong>Note:</strong> If you experience 529 errors from the <code>preload.ipfs.io</code> servers in your console, rest assured that there is nothing wrong with your app. Those servers exist to strengthen the network and increase application performance but they are <em>not</em> necessary. You can re-insert <code>preload: { enabled: false }</code> any time and still remain connected to the global IPFS network</p>
</blockquote>
<h3 id="getting-a-list-of-connected-peers">Getting a list of connected peers</h3>
<p>Your users will want to know which users they are connected to or at the very least how many peers. You will enable that using a simple IPFS function.</p>
<p>Create the <code>getIpfsPeers</code> function inside of the <code>NewPiecePlease</code> class.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ async getIpfsPeers() {</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const peers = await this.node.swarm.peers()</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   return peers</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>Then, in your application code:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> peers <span class="op">=</span> <span class="cf">await</span> NPP<span class="op">.</span><span class="fu">getIpfsPeers</span>()</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(peers<span class="op">.</span><span class="at">length</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co">// 8</span></span></code></pre></div>
<p>Note that this number will increase over time as your swarm automatically grows, so check and update periodically.</p>
<h3 id="manually-connecting-to-peers">Manually connecting to peers</h3>
<p>All users will be running their own IPFS nodes either in the browser or on Node.js. They’ll want to connect together, so you will now allow your users to connect to other peers via their IPFS ids.</p>
<p>There’s a number of ways to model and test this during development - you could open up two browsers, or a public and private window in the same browser. Similarly, you could run one instance of the app in Node.js and the other in the browser. You should be able to connect to any of them.</p>
<p>Create the <code>connectToPeer</code> function inside the <code>NewPiecePlease</code> class:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ async connectToPeer (multiaddr, protocol = &#39;/p2p-circuit/ipfs/&#39;) {</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   try {</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="va">+     await this.node.swarm.connect(protocol + multiaddr)</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="va">+   } catch(e) {</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="va">+     throw (e)</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="va">+   }</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>Then, update the <code>_init</code> function to include an event handler for when a peer is connected:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>  async _init() {</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    const peerInfo = await this.node.id()</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    this.orbitdb = await OrbitDB.createInstance(this.node)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    this.defaultOptions = { accessController: { write: [this.orbitdb.identity.id] }}</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    const docStoreOptions = {</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>      ...this.defaultOptions,</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>      indexBy: &#39;hash&#39;,</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    this.pieces = await this.orbitdb.docstore(&#39;pieces&#39;, docStoreOptions)</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    await this.pieces.load()</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    this.user = await this.orbitdb.kvstore(&#39;user&#39;, this.defaultOptions)</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    await this.user.load()</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    await this.loadFixtureData({</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>      &#39;username&#39;: Math.floor(Math.random() * 1000000),</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>      &#39;pieces&#39;: this.pieces.id,</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>      &#39;nodeId&#39;: peerInfo.id</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a><span class="va">+   this.node.libp2p.on(&#39;peer:connect&#39;, this.handlePeerConnected.bind(this))</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    this.onready()</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>Finally, create the a simple, yet extensible, <code>handlePeerConnected</code> function.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ handlePeerConnected (ipfsPeer) {</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const ipfsId = ipfsPeer.id.toB58String()</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   if (this.onpeerconnect) this.onpeerconnect(ipfsId)</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>In your application code, implement these functions like so:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>NPP<span class="op">.</span><span class="at">onpeerconnect</span> <span class="op">=</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> NPP<span class="op">.</span><span class="fu">connectToPeer</span>(<span class="st">&#39;QmWxWkrCcgNBG2uf1HSVAwb9RzcSYYC2d6CRsfJcqrz2FX&#39;</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co">// some time later, outputs &#39;QmWxWkrCcgNBG2uf1HSVAwb9RzcSYYC2d6CRsfJcqrz2FX&#39;</span></span></code></pre></div>
<h4 id="what-just-happened-13">What just happened?</h4>
<p>You created 2 functions: one that shows a list of peers and another that lets you connect to peers via their multiaddress.</p>
<ul>
<li><code>this.node.swarm.peers()</code> returns a an array of connected peers</li>
<li><code>protocol = '/p2p-circuit/ipfs/'</code> is used as a default since this is a common protocol between browser and Node.js</li>
<li><code>this.node.swarm.connect(protocol + multiaddr)</code> connects to a peer via their a multiaddress that combines <code>protocol</code> and <code>multiaddr</code> into an address like <code>p2p-circuit/ipfs/Qm....</code></li>
<li><code>this.node.libp2p.on('peer:connect', this.handlePeerConnected.bind(this))</code> registers the <code>handlePeerConnected</code> function to be called whenever a peer connects to the application node.</li>
<li><code>ipfsPeer.id.toB58String()</code> is a nice, synchronous way to get the peer id.</li>
</ul>
<h3 id="peer-to-peer-communication-via-ipfs-pubsub">Peer to peer communication via IPFS pubsub</h3>
<p>The term “pubsub” derived from “<strong>pub</strong>lish and <strong>sub</strong>scribe, and is a common messaging model in distributed systems. The idea here is that peers will”broadcast” messages to the entire network via a “topic”, and other peers can subscribe to those topics and receive all the messages.</p>
<p>You can leverage this mechanism to create a simple communication mechanism between the user nodes.</p>
<h4 id="subscribing-to-your-channel">Subscribing to “your” channel</h4>
<p>Your users will need to be able to receive messages that are broadcast to them. You will enable this by having them subscribe to a topic named after their IPFS id.</p>
<p>Update the <code>_init</code> function to look like the following:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>  async _init() {</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    const peerInfo = await this.node.id()</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    this.orbitdb = await OrbitDB.createInstance(this.node)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    this.defaultOptions = { accessController: { write: [this.orbitdb.identity.id] }}</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    const docStoreOptions = {</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>      ...defaultOptions,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>      indexBy: &#39;hash&#39;,</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    this.pieces = await this.orbitdb.docstore(&#39;pieces&#39;, docStoreOptions)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    await this.pieces.load()</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    this.user = await this.orbitdb.kvstore(&#39;user&#39;, this.defaultOptions)</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    await this.user.load()</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    await this.loadFixtureData({</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>      &#39;username&#39;: Math.floor(Math.random() * 1000000),</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>      &#39;pieces&#39;: this.pieces.id,</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>      &#39;nodeId&#39;: peerInfo.id</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    this.node.libp2p.on(&#39;peer:connect&#39;, this.handlePeerConnected.bind(this))</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a><span class="va">+   await this.node.pubsub.subscribe(peerInfo.id, this.handleMessageReceived.bind(this))</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>    this.onready()</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>Then, add the <code>handleMessageReceived</code> function to <code>NewPiecePlease</code></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">handleMessageReceived</span> (msg) {</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">onmessage</span>) <span class="kw">this</span><span class="op">.</span><span class="fu">onmessage</span>(msg)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Use this in your application:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>NPP<span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co">/* When receiving a message, it will output something like:</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co">{</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;from&quot;: &quot;QmVQYfz7Ksimx8a4kqWJinX9BqoiYM5BQVyoCvotVDjj6P&quot;,</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;data&quot;: &quot;&lt;Buffer 64 61 74 61&gt;&quot;,</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;seqno&quot;: &quot;&lt;Buffer 78 3e 6b 8c fd de 5d 7b 27 ab e4 e0 c9 72 4e c0 aa ee 94 20&gt;&quot;,</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;topicIDs&quot;: [ &quot;QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM&quot; ]</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="co">}</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<p>Messages are sent with the data as type <code>Buffer</code> and can contain any JSON-serializable data, and can be decoded using the <code>msg.data.toString()</code> function.</p>
<h4 id="sending-messages-to-peers">Sending messages to peers</h4>
<p>Now that the nodes are listening, they’ll want to send messages to each other. You will enable this to give your users the ability to send messages to each other via the pubsub topics of their IPFS ids.</p>
<p>Create the <code>sendMessage</code> function inside the <code>NewPiecePlease</code> class:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ async sendMessage(topic, message) {</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   try {</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="va">+     const msgString = JSON.stringify(message)</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="va">+     const messageBuffer = this.IPFS.Buffer(msgString)</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="va">+     await this.node.pubsub.publish(topic, messageBuffer)</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="va">+   } catch (e) {</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="va">+     throw (e)</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="va">+   }</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>You can then utilize this function in your application code, and your user will see the output as defined in the previous subsection.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> data <span class="co">// can be any JSON-serializable value</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> hash <span class="op">=</span> <span class="st">&quot;QmXG8yk8UJjMT6qtE2zSxzz3U7z5jSYRgVWLCUFqAVnByM&quot;</span><span class="op">;</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> NPP<span class="op">.</span><span class="fu">sendMessage</span>(hash<span class="op">,</span> data)</span></code></pre></div>
<h4 id="what-just-happened-14">What just happened?</h4>
<p>You enabled a simple message sending and receiving system which allows peer-to-peer communication.</p>
<ul>
<li><code>this.IPFS.Buffer(msgString)</code> encoded the message, after JSON stringification, into a Buffer object.</li>
<li><code>this.node.pubsub.publish(topic, messageBuffer)</code> sends the encoded Buffer to the topic specified. In our case, this will be the IPFS id</li>
</ul>
<blockquote>
<p><strong>Note:</strong> These techniques are presented for <em>educational purposes only</em>, with no consideration as to security or privacy. You should be encrypting and signing messages at the application level. More on this in Chapter 6 of the tutorial.</p>
</blockquote>
<h3 id="key-takeaways-3">Key Takeaways</h3>
<ul>
<li>In order to do anything peer-to-peer, you will need to be connected to the global IPFS network</li>
<li>If you started offline, the default configuration is restorable</li>
<li>Your node announces itself to the network via its <em>swarm</em> addresses</li>
<li>Your node will connect to <em>bootstrap</em> peers automatically, and you can manually connect to peers on command</li>
<li>Peer-to-peer communication is achieved through a “pubsub” model</li>
<li>In pubsub, users subscribe to, and broadcast messages to, “topics”</li>
</ul>
<p><strong>Now, move on to <a href="./05_P2P_Part_2.md">Chapter 05 - Peer-to-Peer, Part 2</a></strong></p>
<ul>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/463">463</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/468">468</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/471">471</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/498">498</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/519">519</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/296">296</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/264">264</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/460">460</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/484">484</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/474">474</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/505">505</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/496">496</a></li>
</ul>
<h2 id="chapter-5-peer-to-peer-part-2-orbitdb">Chapter 5: Peer-to-Peer Part 2 (OrbitDB)</h2>
<blockquote>
<p>OrbitDB utilizes IPFS’s underlying peer-to-peer layer to share data between peers. In this chapter you will learn methods for <em>discovering peers</em>, <em>connecting automatically to known peers</em>, and making <em>distributed queries</em>.</p>
</blockquote>
<div>
<h3>
Table of Contents
</h3>
<p>Please complete <a href="./04_P2P_Part_1.md">Chapter 4 - Peer to Peer</a> first.</p>
<ul>
<li><a href="#enabling-debug-logging">Enabling debug logging</a></li>
<li><a href="#discovering-peers-databases">Discovering Peer’s Databases</a></li>
<li><a href="#connecting-to-another-peers-database">Connecting automatically to peers via IPFS bootstrap</a></li>
<li><a href="#simple-distributed-queries">Simple distributed queries</a></li>
<li><a href="#key-takeaways">Key takeaways</a></li>
</ul>
</div>
<h3 id="enabling-debug-logging">Enabling debug logging</h3>
<p>There’s a lot of moving parts in connecting to a peer’s OrbitDB database, and you will want a deeper look into what’s going on as you start to work with connections.</p>
<p>Throughout the OrbitDB / IPFS stack, logging is controlled via a global variable called <code>LOG</code> which uses string pattern matching to filter and display logs, e.g. <code>LOG="*"</code> will show all logs and be very noisy.</p>
<p>In Node.js, you can enable this by passing an environment variable before the invocation of the <code>node</code> command:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> LOG=<span class="st">&quot;orbit*&quot;</span> node</span></code></pre></div>
<p>In the browser, you can set this as a global variable on <code>window</code>:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="at">LOG</span><span class="op">=</span><span class="st">&#39;orbit*&#39;</span></span></code></pre></div>
<p>Then, once you re-run the app, you should see a great deal of console info, abridged here:</p>
<pre class="plain"><code>[DEBUG] orbit-db: open()
[DEBUG] orbit-db: Open database &#39;/orbitdb/zdpuAz77YioswjyfnnqVDhjycEn4BKFhvxfipTH7y4LCnjvBz/pieces&#39;
[DEBUG] orbit-db: Look from &#39;./orbitdb&#39;
[DEBUG] cache: load, database: /orbitdb/zdpuAz77YioswjyfnnqVDhjycEn4BKFhvxfipTH7y4LCnjvBz/pieces
[DEBUG] orbit-db: Found database &#39;/orbitdb/zdpuAz77YioswjyfnnqVDhjycEn4BKFhvxfipTH7y4LCnjvBz/pieces&#39;
[DEBUG] orbit-db: Loading Manifest for &#39;/orbitdb/zdpuAz77YioswjyfnnqVDhjycEn4BKFhvxfipTH7y4LCnjvBz/pieces&#39;
[DEBUG] orbit-db: Manifest for &#39;/orbitdb/zdpuAz77YioswjyfnnqVDhjycEn4BKFhvxfipTH7y4LCnjvBz/pieces&#39;:
{
  &quot;name&quot;: &quot;pieces&quot;,
  &quot;type&quot;: &quot;docstore&quot;,
  &quot;accessController&quot;: &quot;/ipfs/zdpuB1XW983eHNiCcUFEiApGFt1UEbsfqTBQ7YAYnkVNpLiPF&quot;
}
[DEBUG] cache: load, database: /orbitdb/zdpuAz77YioswjyfnnqVDhjycEn4BKFhvxfipTH7y4LCnjvBz/pieces
[DEBUG] orbit-db: Saved manifest to IPFS as &#39;zdpuAz77YioswjyfnnqVDhjycEn4BKFhvxfipTH7y4LCnjvBz&#39;
[DEBUG] cache: load, database: /orbitdb/zdpuAz77YioswjyfnnqVDhjycEn4BKFhvxfipTH7y4LCnjvBz/pieces</code></pre>
<h4 id="what-just-happened-15">What just happened?</h4>
<p>You enabled debug logging in the app for orbitdb so you can get detailed information about what’s going on when you run certain commands.</p>
<ul>
<li><code>Open database</code> corresponds to your <code>this.orbitdb.keyvalue</code>, <code>this.orbitdb.docs</code> calls which are wrappers around <code>this.orbitdb.open({ type: "keyvalue|docs" })</code></li>
<li>The database <code>manifest</code> is a JSON document stored via <code>ipfs.dag.put</code> at the address in the database location, <code>zdpuAz77YioswjyfnnqVDhjycEn4BKFhvxfipTH7y4LCnjvBz</code> in the above examples. Try using <code>NPP.node.dag.get()</code> to explore that content!</li>
<li><code>load</code> calls then read the database contents into memory and correspond with your <code>db.load</code> calls.</li>
</ul>
<p>Much more information about what’s going on internally is provided in Part 3 of this book, OrbitDB Architecture.</p>
<h3 id="discovering-peers-databases">Discovering Peer’s Databases</h3>
<p>To share data between peers, you will need to know their OrbitDB address. Unfortunately, simply connecting to a peer is not enough, since there’s not a simple way to obtain databases address from a simple IPFS peer-to-peer connection. To remedy this, you will create a simple flow that exchanges user information via IPFS pubsub, and then use OrbitDB’s loading and event system to load and display the data.</p>
<p>In order to provide a proper user experience, you will want to hide as much of the peer and database discovery as possible by using OrbitDB and IPFS internals to exchange database addresses and load data upon peer connection.</p>
<p>The flow you will create will be:</p>
<ol type="1">
<li>User manually requests a connection to a user</li>
<li>On a successful connection, both peers send messages containing their user information via a database address</li>
<li>Peer user databases are loaded, replicated, and inspected for a <code>user</code> key</li>
<li>On a successful discovery, user information is added to our local <code>companions</code> database</li>
</ol>
<p>First, update your <code>handlePeerConnected</code> function to call <code>sendMessage</code> we introduce a timeout here to give the peers a second or two to breathe once they are connected. You can later tune this, or remove it as you see fit and as future IPFS features provide greater network reliability and performance.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>  handlePeerConnected (ipfsPeer) {</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    const ipfsId = ipfsPeer.id.toB58String()</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   setTimeout(async () =&gt; {</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="va">+     await this.sendMessage(ipfsId, { userDb: this.user.id })</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="va">+   }, 2000)</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    if(this.onpeerconnect) this.onpeerconnect(ipfsPeer)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>Now, update your <code>handleMessageReceived</code> function to replicate the user database:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ async handleMessageReceived (msg) {</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const parsedMsg = JSON.parse(msg.data.toString())</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   const msgKeys = Object.keys(parsedMsg)</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="va">+   switch (msgKeys[0]) {</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="va">+     case &#39;userDb&#39;:</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="va">+       var peerDb = await this.orbitdb.open(parsedMsg.userDb)</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="va">+       peerDb.events.on(&#39;replicated&#39;, async () =&gt; {</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="va">+         if (peerDb.get(&#39;pieces&#39;)) {</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="va">+           this.ondbdiscovered &amp;&amp; this.ondbdiscovered(peerDb)</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="va">+         }</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="va">+       })</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="va">+       break</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="va">+     default:</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a><span class="va">+       break</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a><span class="va">+   }</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a><span class="va">+   if(this.onmessage) this.onmessage(msg)</span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>In your application code you can use this functionality like so:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Connect to a peer that you know has a New Piece, Please! user database</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> NPP<span class="op">.</span><span class="fu">connectToPeer</span>(<span class="st">&#39;Qm.....&#39;</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>NPP<span class="op">.</span><span class="at">ondbdiscovered</span> <span class="op">=</span> (db) <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(db<span class="op">.</span><span class="at">all</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co">/* outputs:</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co">{</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;nodeId&quot;: &quot;QmNdQgScpUFV19PxvUQ7mtibtmce8MYQkmN7PZ37HApprS&quot;,</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;pieces&quot;: &quot;/orbitdb/zdpuAppq7gD2XwmfxWZ3MzeucEKiMYonRUXVwSE76CLQ1LDxn/pieces&quot;,</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;username&quot;: 875271</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="co">}</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<h4 id="what-just-happened-16">What just happened?</h4>
<p>You updated your code to send a message to connected peers after 2 seconds, and then registered a handler function for this message that connects to and replicates another user’s database.</p>
<ul>
<li><code>this.sendMessage(ipfsId, { user: this.user.id })</code> utilizes the function you created previously to send a message to a peer via a topic named from their IPFS id</li>
<li><code>this.node.pubsub.subscribe</code> registers an event handler that calls <code>this.handleMessageReceived</code></li>
<li><code>peer.events.on('replicated' ...</code> fires when the database has been loaded and the data has been retrieved from IPFS and is stored locally. It means, simply, that you have the data and it is ready to be used.</li>
</ul>
<blockquote>
<p><strong>Note:</strong> If you’re a security-minded person, this is probably giving you anxiety. That’s ok, these methods are for educational purposes only and are meant to enhance your understanding of how a system like this works. We will cover authorization and authentication in the next chapter.</p>
</blockquote>
<h3 id="connecting-automatically-to-peers-with-discovered-databases">Connecting automatically to peers with discovered databases</h3>
<p>Peer discovery is great, but your users are going to want those peers to stick around so you can continue to use their data and receive new data as those peers add pieces. You will make a couple minor modifications the above functions to enable that now. Also, peers is so technical sounding! Musicians might prefer something like “companions” instead.</p>
<p>First, update your <code>_init</code> function to make a new “companions” database:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>async _init() {</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  const nodeInfo = await this.node.id()</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  this.orbitdb = await OrbitDB.createInstance(this.node)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  this.defaultOptions = { accessController: { write: [this.orbitdb.identity.id] }}</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  const docStoreOptions = {</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    ...this.defaultOptions,</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    indexBy: &#39;hash&#39;,</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  this.pieces = await this.orbitdb.docstore(&#39;pieces&#39;, docStoreOptions)</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  await this.pieces.load()</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  this.user = await this.orbitdb.keyvalue(&#39;user&#39;, this.defaultOptions)</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  await this.user.load()</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a><span class="va">+ this.companions = await this.orbitdb.keyvalue(&#39;companions&#39;, this.defaultOptions)</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a><span class="va">+ await this.companions.load()</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>  await this.loadFixtureData({</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>    &#39;username&#39;: Math.floor(Math.random() * 1000000),</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>    &#39;pieces&#39;: this.pieces.id,</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>    &#39;nodeId&#39;: nodeInfo.id,</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>  this.node.libp2p.on(&#39;peer:connect&#39;, this.handlePeerConnected.bind(this))</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>  await this.node.pubsub.subscribe(nodeInfo.id, this.handleMessageReceived.bind(this))</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a><span class="va">+ this.companionConnectionInterval = setInterval(this.connectToCompanions.bind(this), 10000)</span></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a><span class="va">+ this.connectToCompanions()</span></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>  this.onready()</span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Next, create a <code>getCompanions()</code> abstraction for your application layer</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ getCompanions () {</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   return this.companions.all</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>Then, update your <code>handleMessageReceived</code> function to add a discovered peer’s user database to the <code>companions</code> register:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>  async handleMessageReceived(msg) {</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    const parsedMsg = JSON.parse(msg.data.toString())</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    const msgKeys = Object.keys(parsedMsg)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    switch(msgKeys[0]) {</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>      case &#39;userDb&#39;:</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>        const peerDb = await this.orbitdb.open(parsedMsg.userDb)</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>        peerDb.events.on(&#39;replicated&#39;, async () =&gt; {</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>          if(peerDb.get(&#39;pieces&#39;)) {</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="va">+           await this.companions.set(peerDb.id, peerDb.all)</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>            this.ondbdiscovered &amp;&amp; this.ondbdiscovered(peerDb)</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>        break</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>      default:</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>        break</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>    if(this.onmessage) this.onmessage(msg)</span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>Finally, create the <code>connectToCompanions</code> function:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ async connectToCompanions () {</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const companionIds = Object.values(this.companions.all).map(companion =&gt; companion.nodeId)</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   const connectedPeerIds = await this.getIpfsPeers()</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="va">+   await Promise.all(companionIds.map(async (companionId) =&gt; {</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="va">+     if (connectedPeerIds.indexOf(companionId) !== -1) return</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="va">+     try {</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="va">+       await this.connectToPeer(companionId)</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="va">+       this.oncompaniononline &amp;&amp; this.oncompaniononline()</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="va">+     } catch (e) {</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="va">+       this.oncompanionnotfound &amp;&amp; this.oncompanionnotfound()</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a><span class="va">+     }</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="va">+   }))</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>In your application layer, you can test this functionality like so:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>NPP<span class="op">.</span><span class="at">oncompaniononline</span> <span class="op">=</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>NPP<span class="op">.</span><span class="at">oncompanionnotfound</span> <span class="op">=</span> () <span class="kw">=&gt;</span> { <span class="cf">throw</span>(e) }</span></code></pre></div>
<h4 id="what-just-happened-17">What just happened?</h4>
<p>You created yet another database for your user’s musical companions, and updated this database upon database discovery. You can use this to create “online indicators” for all companions in your UI layer.</p>
<ul>
<li><code>await this.orbitdb.keyvalue('companions', this.defaultOptions)</code> creates a new keyvalue store called “companions”</li>
<li><code>this.companions.all</code> retrieves the full list of key/value pairs from the database</li>
<li><code>this.companions.set(peer.id, peer.all)</code> adds a record to the companions database, with the database ID as the key, and the data as the value stored. Note that you can do nested keys and values inside a <code>keyvalue</code> store</li>
<li><code>companionIds.map</code> will then call <code>this.connectToPeer(companionId)</code> in parallel for all registered companions in your database. If they are found <code>oncompaniononline</code> will fire. If not, <code>oncompanionnotfound</code> will fire next.</li>
</ul>
<h3 id="simple-distributed-queries">Simple distributed queries</h3>
<p>This may be the moment you’ve been waiting for - now you will perform a simple parallel distributed query on across multiple peers, pooling all pieces together into one result.</p>
<p>Create the following function, which combines much of the code you’ve written and knowledge you’ve obtained so far:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ async queryCatalog (queryFn) {</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const dbAddrs = Object.values(this.companions.all).map(peer =&gt; peer.pieces)</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="va">+   const allPieces = await Promise.all(dbAddrs.map(async (addr) =&gt; {</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="va">+     const db = await this.orbitdb.open(addr)</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="va">+     await db.load()</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="va">+     return db.query(queryFn)</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="va">+   }))</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a><span class="va">+   return allPieces.reduce((flatPieces, pieces) =&gt; flatPieces.concat(pieces), this.pieces.query(queryFn))</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>You can now test this by creating a few different instances of the app (try both browser and Node.js instances), connecting them via their peer IDs, discovering their databases, and running <code>NPP.queryCatalog(x =&gt; true)</code>.</p>
<h4 id="what-just-happened-18">What just happened?</h4>
<p>You performed your first distributed query using OrbitDB. We hope that by now the power of such a simple system, under 200 lines of code so far, can be used to create distributed applications.</p>
<ul>
<li><code>this.companions.all</code> will return the current list of discovered companions</li>
<li><code>this.orbitdb.open(addr)</code> will open the peer’s database and <code>db.load</code> will load it into memory</li>
<li><code>db.query(queryFn)</code> will filter the pieces in the peer’s database using the <code>queryFn</code> as a filter</li>
<li><code>allPieces.reduce</code> will take an array of arrays and squash it into a flat array</li>
</ul>
<h3 id="key-takeaways-4">Key takeaways</h3>
<ul>
<li>Debug logging can be enabled through a global <code>LOG</code> variable</li>
<li>You cannot discover a user’s database address through their IPFS id</li>
<li>Database discovery, however, can be achieved by utilizing the IPFS pubsub</li>
<li>When a database is <code>replicated</code>, you reliably have access to the data you requested.</li>
<li>Automatic peer connection can be achieved programmatically based on the data in your database</li>
<li>Once you have a registry of databases with the same schema, you can write JavaScript functions to perform distributed, parallel queries</li>
</ul>
<p><strong>You’re not done yet! <a href="./06_Identity_Permission.md">Chapter 6</a> to learn about how you can vastly extend the identity and access control capabilities of OrbitDB</strong></p>
<h2 id="chapter-6-identity-and-permissions">Chapter 6: Identity and Permissions</h2>
<blockquote>
<p>OrbitDB is extremely flexible and extensible, allowing for security via strong <em>encryption</em>, and <em>custom access control</em> based on your application’s specific code and requirements</p>
</blockquote>
<div>
<h3>
Table of Contents
</h3>
<p>Please complete <a href="./05_P2P_Part_2.md">Chapter 5 - Peer to Peer Part 2 (OrbitDB)</a> first.</p>
<ul>
<li><a href="#on-security">On security</a></li>
<li><a href="#encrypting-and-decrypting-your-data">Encryping and decrypting your data</a></li>
<li><a href="#creating-a-custom-access-controller">Creating a custom access controller</a></li>
</ul>
</div>
<h3 id="on-security">On security</h3>
<p>As we’ve stated before, security-minded people reading this tutorial, or even approaching the distributed industry as a whole, tend to think that this is a wild west full of cowboys who throw caution to the wind while they create systems with security holes you can run a stampede of cattle through.</p>
<p>They’re right. OrbitDB and IPFS are <em>alpha software in an alpha industry</em>, there have been security flaws discovered, reported, and disclosed there. Even so far in our app, the databases you have created in this tutorial are only write-protected via a static ACL.</p>
<p>This has the following implications:</p>
<ol type="1">
<li>Everybody will still be able to read the data given a CID or content hash via a simple <code>ipfs.dag.get</code> or <code>ipfs.get</code> call.</li>
<li>The ACL can never change, which means you can’t add/revoke other write permissions, and if you lose access to your IPFS node, you can never write to it either.</li>
</ol>
<p>Security is a vast topic. People can, and do, spend decades of their lives thinking about and working on security in all its numerous aspects. For the purposes of this tutorial, we will approach security from two perspectives: Encryption and Access control</p>
<h3 id="encrypting-and-decrypting-your-data">Encrypting and decrypting your data</h3>
<p>The first thing you’ll do to mitigate implication #1 above is to encrypt the data locally, and store it in OrbitDB (and therefore IPFS) in its encrypted form. Your users might want to create some private profile fields, so you’ll enable this functionality.</p>
<p>OrbitDB is agnostic in terms of encryption to ensure maximum flexibility with your application layer. However, you can learn a simple method of reading and writing encrypted data to the stores, by creating a simple (and useless in terms of real security) pair of functions.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ encrypt (data) {</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   const stringified = JSON.stringify(data)</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="va">+   const reversed = stringified.split(&#39;&#39;).reverse().join(&#39;&#39;)</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="va">+   return reversed</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="va">+ decrypt (data) {</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="va">+   const unreversed = data.split(&#39;&#39;).reverse().join(&#39;&#39;)</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="va">+   const json = JSON.parse(unreversed)</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="va">+   return json</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>Then, for example, you could update the <code>getProfileFields</code> and <code>updateProfile</code> functions:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="st">- getProfileField (key) {</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="va">+ getProfileField (key, encrypted = false) {</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="st">-    return this.user.get(key)</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="va">+    if (encrypted) key = this.decrypt(key)</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="va">+    let data = this.user.get(key)</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="va">+    if (encrypted) data = this.decrypt(data)</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="va">+    return data</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="st">- async updateProfileField (key, value) {</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="va">+ async updateProfileField (key, value, encrypted = true) {</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a><span class="va">+   if (encrypted) {</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a><span class="va">+     key = this.encrypt(key)</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="va">+     value = this.encrypt(value)</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a><span class="va">+   }</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>    const cid = await this.user.set(key, value)</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>    return cid</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Of course, this is a toy example and only reverses strings, but you can see how encryption can be used to protect your data and “hide it in plain sight,” so to speak.</p>
<h4 id="what-just-happened-19">What just happened?</h4>
<p>You learned a simple but effective method of encrypting and decrypting data for transferring data in and out of OrbitDB.</p>
<ul>
<li><code>this.encrypt</code> will encrypt the data locally in memory before storage</li>
<li><code>this.decrypt</code> will take encrypted data from storage, and decrypt it locally, in memory</li>
</ul>
<p>You have many options to choose from when it comes to encryption, and while we are reticent to make an “official” recommendation, here’s a few places you can start to look:</p>
<ul>
<li><a href="https://nodejs.org/api/crypto.html">Node.js crypto module</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API">Web Crypto Libraries</a></li>
</ul>
<p>Encrypting data will work great given a strong enough encryption method. If you picked correctly, you could wait at the restaurant at the end of the universe until somebody guesses your encryption keys and brute forces your data open. The problem, then, becomes <em>key management</em>.</p>
<h3 id="creating-your-own-authentication-middleware">Creating your own authentication middleware</h3>
<p>Write access to databases is managed using OrbitDB’s access controllers. Access controllers are flexible and extensible; you can either use the default, OrbitDBAccessController, or you can create your own. This means that you can use a third-party application to verify access, such as “Log in with Metamask”, or use custom application code to control access.</p>
<p>If no access controller is specified, OrbitDB will use the default OrbitDBAccessController to grant write access. OrbitDBAccessController allows you to list which peers have access. If no peers are specified, only the creator of the database will be granted write access. The peer’s identity.id property is used to grant write access to a database when using OrbitDBAccessController.</p>
<p>Alternatively, you can define your own rules to manage write access. You will now implement an access controller using a simple example that can be built upon in the future.</p>
<p>Add a simple function to the <code>NewPiecePlease</code> class:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ authenticated() { return true }</span></span></code></pre></div>
<p>It’s not much to look at, but remember that you can put whatever code you want there to return true or false: You can check a cookie, contact an API, or verify identity against a third party service like Keybase or Twitter. You just want this function to return a boolean.</p>
<p>Then, create a brand new JavaScript class called “NPPAccessController”</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ class NPPAccessController extends AccessController {</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="va">+   async canAppend (entry, identityProvider) {</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="va">+     const authenticated = NPP.authenticated()</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="va">+     return Promise.resolve(authenticated)</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="va">+   }</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="va">+   async grant () { }</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span></code></pre></div>
<p>Finally, add this to your options object to include this access controller, and pass in the options when creating databases.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="va">+ const customAccessOptions = {</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="va">+    ...this.defaultOptions,</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="va">+    accessController: NPPAccessController</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="va">+ }</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="va">+ const counterDb = await this.orbitdb.counter(dbName, customAccessOptions)</span></span></code></pre></div>
<p>Your access controller will then utilize the <code>NPP.authenticated</code> function to verify. Right now this will always return <code>true</code>, but you are free to modify that function as you see fit based on your custom needs.</p>
<h4 id="what-just-happened-20">What just happened?</h4>
<p>You created a simple access controller, using code from within the <code>NewPiecePlease</code> class to verify.</p>
<ul>
<li><code>authenticated</code> is your playground - check cookies, ask your servers, do whatever you need to do</li>
<li><code>AccessController</code> is the class you want to extend to create your custom access controllers</li>
<li><code>canAppend</code> is a permission function that returns a resolved promise based on your custom code - a rejected promise means a rejected database append</li>
<li><code>grant</code>, if implemented, would allow you to grant access to new users of the system over time</li>
</ul>
<h3 id="key-takeaways-5">Key takeaways</h3>
<ul>
<li>Security is hard and it is on you, the developer, to keep it in mind as you develop your applications</li>
<li>OrbitDB is unopinionated in terms of security topics, which provides maximal flexibility</li>
<li>Strong encryption is an effective way to ensure your data remains private inside a peer-to-peer swarm</li>
<li>OrbitDB Access Control is fully plugabble and customizable</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>Congratulations, and thank you for completing the tutorial!</p>
<p>By this point, you probably know more about OrbitDB than 99% of the general public, and should be able to start creating distributed applications. You should feel empowered by this knowledge, and the knowledge that this is a frontier as-yet unexplored. So, go forth and <em>create</em>! Just make sure you circle back with us and show us all the cool work you’re doing.</p>
<p>If you have issues with the tutorial, if you find errors or simply have a suggestion as to better approaches, please create a pull request and provide feedback.</p>
<p>The next part of the book, <a href="../02_Thinking_Peer_to_Peer">Thinking Peer to Peer</a>, expands on the concepts that you’ve been exposed to here at a higher level. Read on.</p>
<h1 id="part-2-thinking-peer-to-peer">Part 2: Thinking Peer to Peer</h1>
<h2 id="introduction-2">Introduction</h2>
<p>Knowing the mechanics of how to create distributed applications is only the first step. In order to create truly successful applications that can transcend mere curiosities that only our industry appreciates, you will need a deep understanding of how peer-to-peer applications truly work, and how they interact as a swarm rather than as a client or server.</p>
<p>This won’t be easy - models like client-server and relational databases are pervasive in our industry. While this part of the book is not meant to disparage these technologies, learning to <em>think peer-to-peer</em> will require some re-education and re-programming of your mentality away from these traditional models.</p>
<p>Also, while the resources that you interact with are the same resources you’re used to: computation, memory, and storage, different approaches will be required in order to understand resource limitations and mitigation.</p>
<p>This part concludes with a detailed example of how OrbitDB replicates data, which encompasses many of the topics discussed at a high-level in Part 2.</p>
<h2 id="peer-to-peer-vs-client-server">Peer-to-Peer vs Client-Server</h2>
<blockquote>
<p>The Internet’s most ubiquitous model of content delivery requires that users run clients that connect to centralized servers. Peer-to-peer is a drastically contrasting approach, and this chapter transitions client-server thinking to peer-to-peer, favoring <em>swarms over servers</em>, <em>peers over clients</em>, <em>encryption over authorization</em>, and <em>pubsub messaging over API calls</em>.</p>
</blockquote>
<div>
<h3>
Table of Contents
</h3>
<ul>
<li><a href="#client-server-architecture-a-review">Client-server architecture: a review</a></li>
<li><a href="#peers-vs-clients">Peers vs Clients</a></li>
<li><a href="#swarms-vs-servers">Swarms vs Servers</a></li>
<li><a href="#encryption-vs-authorization">Encryption vs Authorization</a></li>
<li><a href="#pubsub-vs-api-calls">Pubsub vs API Calls</a></li>
</ul>
</div>
<h3 id="client-server-architecture-a-review">Client-server architecture: a review</h3>
<p>In the traditional model, users run <em>clients</em> that connect to a <em>servers</em>, which store and manage their data. Using the easiest example, users can run multiple Facebook clients - the website, mobile apps, SMS interfaces - that then make requests to Facebook servers, which queries and updates their data.</p>
<figure>
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fb/Server-based-network.svg/991px-Server-based-network.svg.png" alt="Client-server Model" /><figcaption aria-hidden="true">Client-server Model</figcaption>
</figure>
<p>Over recent years, this method has been proven problematic in terms of data management, data ownership, and data security. These three together can be singularly referred to as <em>data sovereignty</em>, meaning the user who generated the data has control over who the data are sent to, what the data are used for, and how.</p>
<p>Now, component by component, you can unlearn the traditional way of thinking, and learn how to conceptualize how a peer-to-peer system might be architected and how it might behave.</p>
<h3 id="swarms-vs-servers">Swarms vs Servers</h3>
<p>The first notion you should try to dismiss is that of the server, as they are no longer necessary to run peer-to-peer applications. Yes, applications like IPFS nodes run on servers, but it is designed to run in browsers or on regular desktop computers as well.</p>
<p>In the peer-to-peer model, users start out alone and unconnected with their data only stored locally, but very quickly connect to other peers in the same network in a relatively indiscriminate fashion. There is no real “center” of such a network, and thus it forms a <strong>swarm</strong> of connected peers.</p>
<figure>
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/P2P-network.svg/991px-P2P-network.svg.png" alt="Peer to peer swarm" /><figcaption aria-hidden="true">Peer to peer swarm</figcaption>
</figure>
<p>This approach has obvious pros and cons:</p>
<ul>
<li><strong>Pro:</strong> By default, applications will work offline and keep your data local and safe.</li>
<li><strong>Con:</strong> The peers in the network are “untrusted” and will be able to request your data if they know the content address</li>
<li><strong>Pro:</strong> The network will be robust and self-healing</li>
<li><strong>Con:</strong> If a peer, that has data you need, is offline, you may not be able to access it unless it’s replicated elsewhere</li>
<li><strong>Pro:</strong> If there <em>is</em> a data breach, the so-called blast radius will be contained since it will only affect singular or small groups of devices, not necessarily affecting every user of the application.</li>
<li><strong>Con:</strong> There will be new, as-of-yet unimagined, vectors of attack to deceive and compromise data in these networks.</li>
</ul>
<h4 id="on-serverless">On “Serverless”</h4>
<p>It’s often claimed, and rightly so, that the popular term “serverless” is at best a misnomer, and at worst completely disingenuous. This term was coined to popularize the idea of writing code that can then be run on a “Function-as-a-Service” platform, without any a-priori server set up or configuration, and without on-going costs beyond the immediate execution. However, the <em>serverless</em> name refers only to the developer no longer needing to configure or maintain a server themselves, but servers are still needed.</p>
<p>Peer-to-peer architectures <em>can be</em> the true “serverless.” It is possible, today, to create applications that share user data in a peer-to-peer fashion, avoiding middlemen and third parties, and relying on the surplus computational power. The reason the previous sentence is qualified is because there are some major challenges we will all be facing together in our distributed future:</p>
<ol type="1">
<li>Data Persistence</li>
<li>Payment Gateways</li>
<li>API Relaying</li>
</ol>
<p>For now, you’re going to see a lot more applications that run on <code>localhost</code> by default, that connect to other instances of the application running locally on other computers. There are currently traditional clients that already do this: Gitter, Slack, Discord, to name a few. These desktop apps run locally, but still connect to a server.</p>
<p>Therefore, they are not true <em>peers.</em></p>
<h3 id="peers-vs-clients">Peers vs Clients</h3>
<p>If there are no servers, then it would follow that there are no clients. In the traditional model, the functionality of an application is split up between its server and its client. Perhaps you’ve heard the terms <em>thin client</em>, <em>business layer</em>, <em>front-end</em>, <em>back-end</em>. They all mean specific things but all hint at a core feature of client server - that there is some functionality that a user has access to, and some functionality they don’t.</p>
<p>The concept of a <strong>peer</strong> dismisses this notion, and when users run peer-to-peer applications, they are running the entire application code of the entire system locally. This is true of any true peer-to-peer application you are used to: Bittorrent, a Bitcoin wallet, even a program from previous generations like Kazaa. When you run any of those, you’re running the entire system on your computer, and that’s that. No additional code is required.</p>
<p>While the functionality of the peer is the same across all instances of the application, the true power of a peer-to-peer system comes from its connection to, and interaction with, other peers. A single bittorrent client is useless without other peers to connect to, just as Bitcoin wallet is useless without generating transactions and consensus with other peers and the underlying blockchain.</p>
<h3 id="encryption-vs-authorization">Encryption vs Authorization</h3>
<p>In a system where anybody can connect to anybody else, security becomes paramount. However, without a centralized server, traditional forms of security become impossible. If there are no central chokepoints to marshal data through, there is no place to authorize every user that wants access. Additionally, users often want as much privacy as possible - even demanding full anonymity (or at least pseudonymity) in many cases.</p>
<p>A prime solution to this problem of distributed security is the use of strong encryption: both to encrypt the data <em>at rest</em>, meaning when it is stored on any device, and <em>in transit</em>, meaning when it is being transmitted from one device to another over an internet connection.</p>
<ul>
<li><strong>Pro:</strong> There are many types of encryption that are effectively impossible to crack via brute-force methods, meaning that it will take at least millions of years to guess the encryption key</li>
<li><strong>Con:</strong> If the encryption keys are lost and cannot be recovered, so too is the encrypted data.</li>
<li><strong>Pro:</strong> Systems that pass a large amount of encrypted data, particularly data encrypted via multiple different sets of keypairs, can create a large amount of “noise” making it very difficult for attackers to make heads or tails of what’s going on in the system</li>
<li><strong>Con:</strong> UX can be tricky, particularly for users new to the distributed space who don’t have the same understanding of things like keys and encryption as the developers</li>
<li><strong>Pro:</strong> Any encryption key leaks will only affect data encrypted with those keys, not the entire data set of the system</li>
</ul>
<p>One final trade-off to using keypair encryption as a form of application security is that it introduces the problems in key management, storage, and transfer.</p>
<h3 id="message-passing-vs-api-calls">Message Passing vs API Calls</h3>
<p>As we move away from the traditional client-server model and towards a swarm of connected peers, we must think differently about the communication model. Traditionally, you would send messages via some sort of API - SOAP, REST, etc. The server would then process those requests, and disseminate information back out to the necessary clients.</p>
<p>But now, we have a peer-to-peer swarm where certain clients may not be connected at the time of messaging, and different types of messages need to be sent. Using the message passing model, peers will be able to subscribe to “topics” and other peers will be able to broadcast on those same topics. Users must be connected to a swarm to be able to pubsub with other peers. IPFS implements message passing in the form of <em>pubsub</em> - short for “publish and subscribe.”</p>
<p>Some examples:</p>
<ol type="1">
<li>One peer might want to query the database of all connected peers. They could do so by broadcasting on a “query” topic and then listening for messages broadcast back on a “result” topic.</li>
<li>One peer might be new to the swarm, and would want to announce themselves as online and available to interact with. They could broadcast on an “announce” topic, which would cause other peers to recognize them and connect</li>
<li>Pubsub can also be used as a rudimentary chat protocol, allowing peers to broadcast messages to each other via their Node IDs or some other uniquely identifying value.</li>
</ol>
<p>The names of topics can be defined via unique IDs such as you did in the tutorial to minimize the amount of eavesdropping. These messages should be encrypted in transit, regardless.</p>
<h1 id="part-3-the-architecture-of-orbitdb">Part 3: The Architecture of OrbitDB</h1>
<h2 id="introduction-3">Introduction</h2>
<p>You may still find yourself wondering “but exactly <em>how</em> does OrbitDB use IPFS to store, manage, and edit data?” This part is for you. You’ll now start from the very bottom of the stack and work your way up to the OrbitDB JavaScript API layer, allowing you to understand, in depth, exactly what’s going on internally</p>
<p>This part of the book can be read start-to-finish, or you can utilize it like a reference section, obtaining knowledge from here when you need it. This part culminates in a workshop section that explains how to create your own pluggable stores, allowing for massive amounts of flexibility when designing your own OrbitDB-based applications.</p>
<h2 id="overview-of-orbitdb-architecture">Overview of OrbitDB Architecture</h2>
<figure>
<img src="../images/OrbitDB_Dependency_Graph.jpg" alt="OrbitDB Dependency Graph" /><figcaption aria-hidden="true">OrbitDB Dependency Graph</figcaption>
</figure>
<p><strong><a href="./01_IPFS_Firmament.md">Next: Firmament: The Interplanetary File System</a></strong></p>
<h2 id="firmament-the-interplanetary-file-system">Firmament: The Interplanetary File System</h2>
<blockquote>
<p>In order to understand OrbitDB, you need to understand a few things about how the Interplanetary File System (IPFS) works. IPFS is unique in a number of ways, but the TODO most relevant to you are how it assigns addresses to data, and how <em>linked data</em> structures are created.</p>
</blockquote>
<div>
<h3>
Table of Contents
</h3>
<ul>
<li><a href="#content-addressed-vs-location-addressed">Content-Addressed vs Location-Addressed</a></li>
<li><a href="#directed-acyclic-graphs">Directed Acyclic Graphs</a></li>
</ul>
</div>
<h3 id="content-addressed-vs-location-addressed">Content-Addressed vs Location-Addressed</h3>
<p>Most content on the internet is <em>location-addressed</em>. You type in a familiar name, such as <a href="https://github.com/orbitdb">https://github.com/orbitdb</a> and that request is sent to the Domain Name System (DNS), which queries, cross-references, and determines which servers out of the millions out there are the ones with your data on it. Then, that server would understand how to process your query, and send the data back.</p>
<figure>
<img src="../images/Location-Addressed.jpg" alt="Location-Addressed Illustration" /><figcaption aria-hidden="true">Location-Addressed Illustration</figcaption>
</figure>
<p>In IPFS, your files are instead <em>content-addressed</em>. When you add content to IPFS, that content is given an address based on <em>what</em> it is, freeing it from the constraints of its location. You simply ask for what you want, by its <em>hash</em>, and multiple servers can respond at the same time if they have the data.</p>
<figure>
<img src="../images/Content-Addressed.jpg" alt="Content-Addressed Hashing" /><figcaption aria-hidden="true">Content-Addressed Hashing</figcaption>
</figure>
<p>Content addressing is achieved by a technique called <em>hashing</em>, which is a very oblique way of saying “chops up your data into blocks, sum them together repeatedly, and reduce the file down to a unique, consistently-sized alphanumeric string.” This is a process identical to generating a “checksum,” if you’re familiar with that.</p>
<p>For hashing algorithms, there are currently two standards in play: Content ID version 0 (CIDv0) and Content ID version 1 (CIDv1).</p>
<ul>
<li>CIDv0 hashes look like this: <code>QmWpvK4bYR7k9b1feM48fskt2XsZfMaPfNnFxdbhJHw7QJ</code></li>
<li>CIDv1 hashes look like this: <code>zdpuAmRtbL62Yt5w3H6rpm8PoMZFoQuqLgxoMsDJR5frJGxKJ</code></li>
</ul>
<blockquote>
<p><strong>Note:</strong> These hashes are a special type called a <a href="https://github.com/multiformats/multihash">multihash</a>. In practice, this means they have self-describing prefixes. If you see something starting with <code>zdpu</code>, you know it’s a CIDv1.</p>
</blockquote>
<p>The two main reasons to switch to content addressing are <em>performance</em> and <em>verifiability</em>. The performance boost comes from the fact that you can download files simultaneously from multiple peers, similar to Bittorrent. The hashes are also verifiable, meaning that you only download data you request. No other data can have that same hash.</p>
<h4 id="example">Example</h4>
<p>Let’s take a very famous file, and add it to IPFS. Here’s the plain-text MIT license:</p>
<pre class="plain"><code>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
associated documentation files (the &quot;Software&quot;), to deal in the Software without restriction,
including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense,
and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so,
subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial
portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT
NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</code></pre>
<p>If you copy and paste that , newlines and all, into a file named <code>MIT</code> and then add that text to IPFS, it will return <code>QmWpvK4bYR7k9b1feM48fskt2XsZfMaPfNnFxdbhJHw7QJ</code> every time. That is now, and will be in the future, the <em>content address</em> of that file.</p>
<h3 id="directed-acyclic-graphs">Directed Acyclic Graphs</h3>
<p>This is a <em>graph</em> of connected <em>nodes</em>. Think of a network of computers connected via Ethernet cable. Ethernet is directionless; the computers are simply “connected.”</p>
<figure>
<img src="../images/Simple-Graph.jpg" alt="Simple Graph" /><figcaption aria-hidden="true">Simple Graph</figcaption>
</figure>
<p>This is a <em>directed graph</em>. Connections flow in a certain direction, but can be reciprocal. Think of users on a social media network that allows “following.” You following another user is not the same as them following you, but following can be mutual.</p>
<figure>
<img src="../images/Directed-Graph.jpg" alt="Directed Graph" /><figcaption aria-hidden="true">Directed Graph</figcaption>
</figure>
<p>This is a <em>directed acyclic graph</em> or a “DAG”. Connections only flow in one direction and never “cycle.” or loop back. This</p>
<figure>
<img src="../images/Directed-Acyclic-Graph.jpg" alt="Directed Acyclic Graph" /><figcaption aria-hidden="true">Directed Acyclic Graph</figcaption>
</figure>
<p>Node connections are generally represented in data by storing a pointer to another node id. For example, modeling a twitter follow in JSON might look something like <code>{ id: "@your_username", follows: "@aphelionz" }</code>. In a DAG, a common and very effective way is to point directly their CIDs - the unique cryptographic hash of the content you’re looking for. This gives you benefits of using CIDS in general: verifiability and performance, and also the added benefit of being able to <em>enforce</em> the acyclic property of the graph - it is effectively impossible for any past nodes to predict the hashes of future nodes in order to store a pointer to them ahead of time.</p>
<blockquote>
<p><strong>Note:</strong> This technique of using cryptographic hashes to link data is named after <a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C22&amp;q=ralph+merkle&amp;btnG=">Ralph Merkle</a>, so this data structure is called a <em>Merkle DAG</em>.</p>
</blockquote>
<h4 id="example-1">Example</h4>
<p>TODO: <code>ipfs.dag</code> example</p>
<h2 id="the-ipfs-log-package">The <a href="https://github.com/orbitdb/ipfs-log"><code>ipfs-log</code></a> package</h2>
<blockquote>
<p>The funcionality provided by the <a href="https://github.com/orbitdb/ipfs-log"><code>ipfs-log</code></a> package is an implementation of a <em>Conflict-Free Replicated Data Type</em> (CRDT) that utilizes IPFS’s built in <em>directed acyclic graph</em> (DAG) functionality to link data in a specific way. The functionality in this package forms the backbone of orbit-db.</p>
</blockquote>
<div>
<h3>
Table of Contents
</h3>
<ul>
<li><a href="#the-conflict-free-replicated-data-type-CRDT">The Conflict-Free Replicated Data Type (CRDT)</a></li>
<li><a href="#lamport-clocks">Lamport Clocks</a></li>
<li><a href="#heads-and-tails">Heads and Tails</a></li>
</ul>
</div>
<h3 id="the-conflict-free-replicated-data-type-crdt">The Conflict-Free Replicated Data Type (CRDT)</h3>
<p>In the <a href="../01_IPFS_Firmament.md">previous chapter</a> we discussed how we can use IPFS’s <em>directted acyclic graph</em> (DAG) functionality to create linked data structures. OrbitDB utilizes this by building logs wherein each entry is linked to the previous one. To share state reliably between users, and to prevent the system from being confused as to how to parse these logs deterministically, a specific type of data structure called a <em>Conflict-Free Replicated Data Type</em>, or CRDT is used.</p>
<p>A CRDT is a type of log that solves the problem of locally storing and ultimately merging distrubuted data sets to other distributed data sets<sup>1</sup>. CRDTs allows users to perform operations on local databases with the intent of merging or joining those data with the data stored on the devices of other peers in the network.</p>
<p>The <a href="https://github.com/orbitdb/ipfs-log"><code>ipfs-log</code></a> package specifically uses a G-Set CRDT, which in practice means append-only with no deletetion.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GSet {</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constuctor</span> (values) {}</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">append</span> (value) {}</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span> (set) {}</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get</span> (value) {}</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">has</span> (value) {}</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  get <span class="fu">values</span> () {}</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  get <span class="fu">length</span> () {}</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="lamport-clocks">Lamport Clocks</h3>
<p>To achieve successful merging - merging that is properly associative and deterministic - entries are timestamped with something called a Lamport Clock<sup>2</sup>. The timestamp of each entry is a pair of values: a logical clock counter of the entry (as opposed to wall clock), and an identifier of the user or device that generated the entry.</p>
<p>In the case of /, the identifier is the public key of the IPFS node where the entries are initially generated.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">Lamport</span> <span class="er">Clock</span> <span class="er">Object</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;042750228c5d81653e5142e6a56d55...e5216b9a6612dbfc56e906bdbf34ea373c92b30d7&quot;</span><span class="fu">,</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;time&quot;</span><span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<blockquote>
<p><strong>Note:</strong> The “time” field is a monotonically increasing integer that increments each time a new entry is added to the log. It is not “wall time”, e.g. a unix timestamp.</p>
</blockquote>
<h3 id="heads-and-tails">Heads and Tails</h3>
<p>Heads and Tails are important concepts in terms of CRDTs, and many people require a bit of explanation before fully understanding the concept and its implications.</p>
<h4 id="heads">Heads</h4>
<p>The head of a log is an entry that is not referenced by any other entry. Practically speaking, these are the latest entries being appended to a log or logs.</p>
<p>This is best understood by example, observing how the heads change over time. In the following examples, circles are entries, green circles are heads, and arrows denote the pointers contained in the entry, to the previous record.</p>
<p>Let’s start with the simplest example - a single user writing entries to a single log.</p>
<figure>
<img src="../images/single-node-log-over-time.png" alt="Single-Node CRDT over time, Simplest Example" /><figcaption aria-hidden="true">Single-Node CRDT over time, Simplest Example</figcaption>
</figure>
<p>However, we are not in the business of single-device / single-user logs, so let’s imagine the following scenario in an attempt to find the least-complex, but still complete example of how the heads would work over time.</p>
<p>First, in plain words and some pseudocode:</p>
<ol type="1">
<li>User 1 starts a Log (<code>log1 = new Log</code>)</li>
<li>User 2 starts a Log (<code>log2 = new Log</code>)</li>
<li>User 1 adds two entries to the log (<code>log1.append</code>)</li>
<li>User 2 merges that log with their own (<code>log2.join(log1)</code>)</li>
<li>User 1 adds two more entries (<code>log1.append</code>)</li>
<li>User 2 adds an entry (<code>log2.append</code>)</li>
<li>User 2 merges the log again (<code>log2.join</code>)</li>
<li>User 2 adds one more entry (<code>log2.append</code>)</li>
</ol>
<p>Now in a diagram:</p>
<figure>
<img src="../images/multiple-nodes-log-over-time.png" alt="Multiple Nodes Over Time" /><figcaption aria-hidden="true">Multiple Nodes Over Time</figcaption>
</figure>
<p>We can then see how it’s possible that a CRDT may have more than one head entry (maybe hundreds) and how those entries change over time with multiple users.</p>
<h4 id="tails">Tails</h4>
<p>A CRDT of any size can be stored in IPFS. However, When performing computations on the data, it needs to be loaded into an “input array” (i.e. subset of the log) that exists in a finite memory space. The tails of such a log point to entries that are not in the input array.</p>
<p>For our example, let’s imagine a log with hundreds of millions of entries. You don’t have access to a supercomputing center so tt’s not feasible to load the log into memory. Thus, we use a partial traversal of the log, the tails of which contain the pointers to the next records to be traversed, if we so choose.</p>
<p>This concept is visualized below, with the dim entries signifying non-traversed, and the orange entries signifying tails.</p>
<figure>
<img src="../images/tails-example.png" alt="Tails Example" /><figcaption aria-hidden="true">Tails Example</figcaption>
</figure>
<h3 id="anatomy-of-a-log-entry">Anatomy of a Log Entry</h3>
<p><code>ipfs-log</code> entries are JSON objects that follow a specific schema to form linked lists, or “chains” in a (Directed Acyclic Graph) DAG. In doing so, IPFS can be utilized as an append-only operation log.</p>
<p>What follows is sort of a “minimum viable example” of such a log. Below the example is a field-by-field explanation of what’s going on.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;hash&quot;</span><span class="fu">:</span> <span class="st">&quot;zdpuAmL9zAgC4KFdMWW6yjpEcSYTnBunjTeijHv8GTKrxoz7D&quot;</span><span class="fu">,</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;example-log&quot;</span><span class="fu">,</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;payload&quot;</span><span class="fu">:</span> <span class="st">&quot;one&quot;</span><span class="fu">,</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;next&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;v&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;clock&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;04524f55b54154aa9ec5a54118821c666d19825c0b4e4e91fac387035dbf679803cbdc858b052558f75d5e52ed5b2c38b94d4f652ee63142bae91b95df3b36fe4b&quot;</span><span class="fu">,</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;time&quot;</span><span class="fu">:</span> <span class="dv">1</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;04524f55b54154aa9ec5a54118821c666d19825c0b4e4e91fac387035dbf679803cbdc858b052558f75d5e52ed5b2c38b94d4f652ee63142bae91b95df3b36fe4b&quot;</span><span class="fu">,</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;identity&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;0281c2c485e5f03f006f8e7ccb34f4281d2d7ae7d8571660e745eb4e07b4d8f35d&quot;</span><span class="fu">,</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;publicKey&quot;</span><span class="fu">:</span> <span class="st">&quot;04524f55b54154aa9ec5a54118821c666d19825c0b4e4e91fac387035dbf679803cbdc858b052558f75d5e52ed5b2c38b94d4f652ee63142bae91b95df3b36fe4b&quot;</span><span class="fu">,</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;signatures&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;3045022100c7fe5bab3844e197cccc9dc0962977f0381b96acaf9518688a278e0f8ddbc78d0220137e7d154a076319fe418e24f4d861683cf6823f3f725d1f4eb30b17cb1f3fbe&quot;</span><span class="fu">,</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;publicKey&quot;</span><span class="fu">:</span> <span class="st">&quot;3044022043dc1a586910538cd534666d8c66599e6349e82c6ba7fe5bf4d43cfefc4a3e9f02205838a492371fee3f22e4aeeeda9d0f8c1176bf16f64139049b0c6b47d89a8e63&quot;</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;orbitdb&quot;</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;sig&quot;</span><span class="fu">:</span> <span class="st">&quot;3045022100e85408f20d8917eea076e091a64507c1115f9314cf8578b1c483810e82dc6b8902206649fea6407261157310ef59fc518bb902a7b32a9ddf55817a6010df004ed452&quot;</span></span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;hash&quot;</span><span class="fu">:</span> <span class="st">&quot;zdpuAoGa1MseCvKwbk9xdGK6aNyB5JqdYX8WrkUA8UCz7fRut&quot;</span><span class="fu">,</span></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;example-log&quot;</span><span class="fu">,</span></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;payload&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;two&quot;</span><span class="fu">:</span> <span class="st">&quot;hello&quot;</span></span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;next&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;zdpuAmL9zAgC4KFdMWW6yjpEcSYTnBunjTeijHv8GTKrxoz7D&quot;</span></span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;v&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;clock&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;04524f55b54154aa9ec5a54118821c666d19825c0b4e4e91fac387035dbf679803cbdc858b052558f75d5e52ed5b2c38b94d4f652ee63142bae91b95df3b36fe4b&quot;</span><span class="fu">,</span></span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;time&quot;</span><span class="fu">:</span> <span class="dv">2</span></span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;04524f55b54154aa9ec5a54118821c666d19825c0b4e4e91fac387035dbf679803cbdc858b052558f75d5e52ed5b2c38b94d4f652ee63142bae91b95df3b36fe4b&quot;</span><span class="fu">,</span></span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;identity&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;0281c2c485e5f03f006f8e7ccb34f4281d2d7ae7d8571660e745eb4e07b4d8f35d&quot;</span><span class="fu">,</span></span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;publicKey&quot;</span><span class="fu">:</span> <span class="st">&quot;04524f55b54154aa9ec5a54118821c666d19825c0b4e4e91fac387035dbf679803cbdc858b052558f75d5e52ed5b2c38b94d4f652ee63142bae91b95df3b36fe4b&quot;</span><span class="fu">,</span></span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;signatures&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb83-43"><a href="#cb83-43" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;3045022100c7fe5bab3844e197cccc9dc0962977f0381b96acaf9518688a278e0f8ddbc78d0220137e7d154a076319fe418e24f4d861683cf6823f3f725d1f4eb30b17cb1f3fbe&quot;</span><span class="fu">,</span></span>
<span id="cb83-44"><a href="#cb83-44" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;publicKey&quot;</span><span class="fu">:</span> <span class="st">&quot;3044022043dc1a586910538cd534666d8c66599e6349e82c6ba7fe5bf4d43cfefc4a3e9f02205838a492371fee3f22e4aeeeda9d0f8c1176bf16f64139049b0c6b47d89a8e63&quot;</span></span>
<span id="cb83-45"><a href="#cb83-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb83-46"><a href="#cb83-46" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;orbitdb&quot;</span></span>
<span id="cb83-47"><a href="#cb83-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb83-48"><a href="#cb83-48" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;sig&quot;</span><span class="fu">:</span> <span class="st">&quot;304402207cb815276e16d222759f65558d22c3067b54be86f1ce66f1be057e7c188367d6022050e4b93ddc40bc174b725623473a00412cb56180254c18ec34b616afe4ef1840&quot;</span></span>
<span id="cb83-49"><a href="#cb83-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb83-50"><a href="#cb83-50" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div>
<ul>
<li><strong>hash</strong>: the hash of the entry, in cidv1 format (this will switch to base32 soon)</li>
<li><strong>id</strong>: the user-supplied ID of the log</li>
<li><strong>payload</strong>: the actual content of the log entry, can be any JSON-serializable object</li>
<li><strong>next</strong>: an array of hashes that point to previous log entries from the <em>head</em> of the log.</li>
<li><strong>v</strong>: the version of the log schema. Typically for internal tracking only and migration purposes</li>
<li><strong>clock</strong> the lamport clock values. explained above</li>
<li><strong>key</strong> the orbitdb-generated public key for verification purposes</li>
<li><strong>identity</strong> the identity object. defaults to the standard OrbitDB identity but can be customized</li>
<li><strong>sig</strong> the signaure of the entry, signed by the orbitdb private key, for verification purposes</li>
</ul>
<h4 id="references">References</h4>
<ol type="1">
<li><a href="https://citemaster.net/get/10b50274-7bc5-11e5-8aa1-00163e009cc7/p558-lamport.pdf" class="uri">https://citemaster.net/get/10b50274-7bc5-11e5-8aa1-00163e009cc7/p558-lamport.pdf</a></li>
<li><a href="https://hal.inria.fr/inria-00555588" class="uri">https://hal.inria.fr/inria-00555588</a></li>
</ol>
<h2 id="the-orbitdb-stores">The OrbitDB Stores</h2>
<h3 id="keyvalue">Keyvalue</h3>
<h3 id="docstore">Docstore</h3>
<h3 id="counter">Counter</h3>
<h3 id="log">Log</h3>
<h3 id="feed">Feed</h3>

<h2 id="orbitdb-replication">OrbitDB Replication</h2>
<blockquote>
<p>OrbitDB replication is something that happens automatically, under the hood. Understanding how to use it is one thing, but many times you’ll want a deeper understanding of what happens, step-by-step when a database is created and data is transferred between peers.</p>
</blockquote>
<div>
<h3>
Table of Contents
</h3>
<ul>
<li><a href="#replication-step-by-step">Replication, step-by-step</a></li>
<li><a href="#on-sharding">On “Sharding”</a></li>
</ul>
</div>
<h3 id="replication-step-by-step">Replication, step-by-step</h3>
<p>In the tutorial, you learned how to enable debug logging and were able to see the steps of replication take place in your console output. Here, you will be able to dissect these logs and learn how OrbitDB shares data between peers reliably by sharing a minimal amount of data to start.</p>
<p>To review,</p>
<h3 id="on-sharding">On “Sharding”</h3>
<p>There have been questions about how sharding is handled in such a peer-to-peer database system.</p>
<h2 id="chapter-5---the-restful-api">Chapter 5 - The RESTful API</h2>
<blockquote>
<p>Integrate OrbitDB into your applications using alternative programming languages and frameworks.</p>
</blockquote>
<div>
<h3>
Table of Contents
</h3>
<ul>
<li><a href="#setting-up">Setting up</a></li>
<li><a href="#obtaining-the-ssl-certificates">Obtaining the SSL certificates</a></li>
<li><a href="#interacting-with-orbitdb-over-http">Interacting with OrbitDB over HTTP</a></li>
<li><a href="#replicating">Replicating</a></li>
<li><a href="#key-takeaways">Key takeaways</a></li>
</ul>
</div>
<h3 id="setting-up">Setting up</h3>
<p>Running an OrbitDB REST server is relatively straight-forward but some knowledge of working on the command line will be required. These steps assume you are running Linux or some other Unix-based operating system. For Windows users, you will need to translate the commands to your environment. Prerequisites</p>
<p>Firstly, it is assumed that you can use a command line and install software as all commands will be run from the terminal.</p>
<p>You will also need two machines running since we will be replicating a decentralized database. This can either be two physical computers, a couple of virtual machines or docker containers.</p>
<p>Lastly, because the OrbitDB server uses Node.js you will also need npm (bundled with Node.js) to install the dependencies. This tutorial will not cover the installation and configuration of these requirements.</p>
<h4 id="running-ipfs">Running IPFS</h4>
<p>OrbitDB uses IPFS to distribute and replicate data stores. The OrbitDB HTTP server runs in one of two modes; local or api.</p>
<p>When run in Local mode, OrbitDB will run its own IPFS node. When run in api mode, OrbitDB will connect to an already-running IPFS node.</p>
<p>For this tutorial we will connect to a running IPFS daemon and will assume you already have this installed. You will also want to run IPFS daemon with pubsub enabled.</p>
<p>Start your first IPFS daemon by running:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ipfs</span> daemon <span class="at">--enable-pubsub-experiment</span></span></code></pre></div>
<h4 id="building-the-rest-server">Building the REST server</h4>
<p>Now get a copy of the code. You can grab it via Github at <a href="https://github.com/orbitdb/orbit-db-http-api" class="uri">https://github.com/orbitdb/orbit-db-http-api</a>:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://github.com/orbitdb/orbit-db-http-api.zip</span></code></pre></div>
<p>Alternatively, you can clone the git repo:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/orbitdb/orbit-db-http-api.git</span></code></pre></div>
<p>Install your dependencies:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install</span></code></pre></div>
<h3 id="obtaining-the-ssl-certificates">Obtaining the SSL certificates</h3>
<p>The latest version of the OrbitDB HTTP API incorporates HTTP/2. Therefore, to run the server, you will need to generate SSL certificates.</p>
<p>There are a couple of options available for obtaining certificates; you can issue a certificate using a certificate authority such as Let’s Encrypt, or, you can become your own CA. For development environments, the second option may be better and a thorough overview on how to do this is covered in the section <a href="#generating-a-self-signed-certificate">Generating a self-signed certificate</a>.</p>
<p>The rest of this tutorial will assume you have a trusted SSL certificate set up and that curl will use your trust store to validate the certificate. If not, you will need to tell curl to ignore the certificate verification by passing the -k flag:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-k</span> <span class="at">-X</span> GET ...</span></code></pre></div>
<h4 id="generating-a-self-signed-certificate">Generating a self-signed certificate</h4>
<p>To get started, you are going to create a root certificate which you will use to sign additional SSL certificates with.</p>
<p>First, create your root CA private key:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="ex">openssl</span> genrsa <span class="at">-des3</span> <span class="at">-out</span> rootSSL.key 2048</span></code></pre></div>
<div class="sourceCode" id="cb90"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Generating</span> RSA private key, 2048 bit long modulus</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="ex">………………+++</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="ex">………………………………………………………………………+++</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="ex">e</span> is 65537 <span class="er">(</span><span class="ex">0x010001</span><span class="kw">)</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Enter</span> pass phrase for rootSSL.key:</span></code></pre></div>
<p>You will be prompted for a password. Be sure to specify one that is long enough as you may encounter errors if your password is too short.</p>
<p>Next, use your CA private key to create a root certificate:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="ex">openssl</span> req <span class="at">-x509</span> <span class="at">-new</span> <span class="at">-nodes</span> <span class="at">-key</span> rootSSL.key <span class="at">-sha256</span> <span class="at">-days</span> 1024 <span class="at">-out</span> rootSSL.pem</span></code></pre></div>
<p>Once launched, you will need to re-enter the password you assigned to your private key:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Enter</span> pass phrase for rootSSL.key:</span></code></pre></div>
<p>If successful, provide information about your certificate:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a> <span class="ex">You</span> are about to be asked to enter information that will be incorporated</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a> <span class="ex">into</span> your certificate request.</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a> <span class="ex">What</span> you are about to enter is what is called a Distinguished Name or a DN.</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">There</span> are quite a few fields but you can leave some blank</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">For</span> some fields there will be a default value,</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">If</span> you enter <span class="st">&#39;.&#39;</span>, the field will be left blank.</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a> <span class="ex">Country</span> Name <span class="er">(</span><span class="ex">2</span> letter code<span class="kw">)</span> <span class="ex">[AU]:</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">State</span> or Province Name <span class="er">(</span><span class="ex">full</span> name<span class="kw">)</span> <span class="ex">[Some-State]:WA</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">Locality</span> Name <span class="er">(</span><span class="ex">eg,</span> city<span class="kw">)</span> <span class="ex">[]:</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">Organization</span> Name <span class="er">(</span><span class="ex">eg,</span> company<span class="kw">)</span> <span class="ex">[Internet</span> Widgits Pty Ltd]:</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">Organizational</span> Unit Name <span class="er">(</span><span class="ex">eg,</span> section<span class="kw">)</span> <span class="ex">[]:</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">Common</span> Name <span class="er">(</span><span class="ex">e.g.</span> server FQDN or YOUR name<span class="kw">)</span> <span class="ex">[]:localhost</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">Email</span> Address []:</span></code></pre></div>
<p>You are now ready to install the new CA certificate into your CA trust store. The following commands will copy the root certificate into Ubuntu’s CA store so you may need to modify the paths if you are on a different distribution or OS platform:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mkdir /usr/local/share/ca-certificates/extra</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> cp rootSSL.pem <span class="dt">\/</span>usr/local/share/ca-certificates/extra/rootSSL.crt</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> update-ca-certificates</span></code></pre></div>
<p>Now it is time to generate a certificate for your development environment. Create a private key for your new certificate:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="ex">openssl</span> req <span class="dt">\</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a> <span class="at">-new</span> <span class="at">-sha256</span> <span class="at">-nodes</span> <span class="dt">\</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a> <span class="at">-out</span> localhost.csr <span class="dt">\</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a> <span class="at">-newkey</span> rsa:2048 <span class="at">-keyout</span> localhost.key <span class="dt">\</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a> <span class="at">-subj</span> <span class="st">&quot;/C=AU/ST=WA/L=City/O=Organization/OU=OrganizationUnit/CN=localhost/emailAddress=demo@example.com&quot;</span></span></code></pre></div>
<p>Next, create the certificate, signing it with your Root CA:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="ex">openssl</span> x509 <span class="dt">\</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a> <span class="at">-req</span> <span class="dt">\</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a> <span class="at">-in</span> localhost.csr <span class="dt">\</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a> <span class="at">-CA</span> rootSSL.pem <span class="at">-CAkey</span> rootSSL.key <span class="at">-CAcreateserial</span> <span class="dt">\</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a> <span class="at">-out</span> localhost.crt <span class="dt">\</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a> <span class="at">-days</span> 500 <span class="dt">\</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a> <span class="at">-sha256</span> <span class="dt">\</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a> <span class="at">-extfile</span> <span class="op">&lt;(</span><span class="bu">echo</span> <span class="st">&quot; </span><span class="dt">\</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="st">    [ v3_ca ]\n </span><span class="dt">\</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a><span class="st">    authorityKeyIdentifier=keyid,issuer\n </span><span class="dt">\</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="st">    basicConstraints=CA:FALSE\n </span><span class="dt">\</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="st">    keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment\n </span><span class="dt">\</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a><span class="st">    subjectAltName=DNS:localhost </span><span class="dt">\</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a><span class="st">   &quot;</span><span class="op">)</span></span></code></pre></div>
<p>Your self-signed SSL certificate is now ready to use.</p>
<h3 id="interacting-with-orbitdb-over-http">Interacting with OrbitDB over HTTP</h3>
<h4 id="starting-the-http-api-server">Starting the HTTP API server</h4>
<p>Start up the OrbitDB server and connect to your running ipfs daemon:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> src/cli.js api <span class="at">--ipfs-host</span> localhost <span class="at">--orbitdb-dir</span> ./orbitdb <span class="at">--https-key</span> localhost.key <span class="at">--https-cert</span> localhost.crt</span></code></pre></div>
<p>The <code>–https-key</code> and <code>–https-cert</code> options above assume you are using the self-signed certificate you created earlier. If not, replace with your own certificate and key.</p>
<h3 id="consuming-your-first-request">Consuming your first request</h3>
<p>The REST server is now running. You can test this by running something simple (we are going to use cURL to run the rest of these command so make sure you have it installed):</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> GET https://localhost:3000/identity</span></code></pre></div>
<p>This will return a JSON string representing your OrbitDB node’s identity information. This includes your public key (which we will use later).</p>
<h4 id="creating-a-database-1">Creating a database</h4>
<p>Creating a data store is very easy with the REST API and you can launch a store based on any of the supported types. For example, you can create a feed data store by running:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST https://localhost:3000/db/my-feed <span class="at">--data</span> <span class="st">&#39;create=true&#39;</span> <span class="at">--data</span> <span class="st">&#39;type=feed&#39;</span></span></code></pre></div>
<p>You can also use JSON to specify the initial data store features:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST https://localhost:3000/db/my-feed <span class="at">-H</span> <span class="st">&quot;Content-Type: application/json&quot;</span> <span class="at">--data</span> <span class="st">&#39;{&quot;create&quot;:&quot;true&quot;,&quot;type&quot;:&quot;feed&quot;}&#39;</span></span></code></pre></div>
<h4 id="adding-some-data">Adding some data</h4>
<p>Let’s add some data to our feed:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST https://localhost:3000/db/my-feed/add <span class="at">--data-urlencode</span> <span class="st">&quot;A beginner&#39;s guide to OrbitDB REST API&quot;</span></span></code></pre></div>
<p>And viewing the data we have just added:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> GET  https://localhost:3000/db/my-feed/all</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[</span><span class="st">&quot;A beginner&#39;s guide to OrbitDB REST API&quot;</span><span class="ex">]</span></span></code></pre></div>
<p>Be aware that there are two different endpoints for sending data to the store, and which endpoint you use will depend on the store’s type. For example you will need to call /put when adding data to a docstore.</p>
<h3 id="replicating">Replicating</h3>
<p>Replicating is where the real power of distribution lies with OrbitDB. Replication is as simple as running an OrbitDB REST node on another machine.</p>
<p>Assuming you have a second computer which is accessible over your intranet or via Docker or a virtual machine, you can replicate the my-feed feed data store.</p>
<h4 id="getting-ready-to-replicate">Getting ready to replicate</h4>
<p>Before you replicate your feed data store, you will need to make a note of its address. You can do this by querying the data store’s details:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> https://localhost:3000/db/my-feed</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span><span class="st">&quot;address&quot;</span><span class="dt">:{</span><span class="st">&quot;root&quot;</span><span class="dt">:</span><span class="st">&quot;zdpuAzCDGmFKdZuwQzCZEgNGV9JT1kqt1NxCZtgMb4ZB4xijw&quot;</span><span class="op">,</span><span class="st">&quot;path&quot;</span><span class="dt">:</span><span class="st">&quot;my-feed&quot;</span><span class="dt">}</span><span class="op">,</span><span class="st">&quot;dbname&quot;</span><span class="dt">:</span><span class="st">&quot;my-feed&quot;</span><span class="op">,</span><span class="st">&quot;id&quot;</span><span class="dt">:</span><span class="st">&quot;/orbitdb/zdpuAzCDGmFKdZuwQzCZEgNGV9JT1kqt1NxCZtgMb4ZB4xijw/my-feed&quot;</span><span class="op">,</span><span class="st">&quot;options&quot;</span><span class="dt">:{</span><span class="st">&quot;create&quot;</span><span class="dt">:</span><span class="st">&quot;true&quot;</span><span class="op">,</span><span class="st">&quot;localOnly&quot;</span><span class="dt">:false</span><span class="op">,</span><span class="st">&quot;maxHistory&quot;</span><span class="dt">:-1</span><span class="op">,</span><span class="st">&quot;overwrite&quot;</span><span class="dt">:true</span><span class="op">,</span><span class="st">&quot;replicate&quot;</span><span class="dt">:true}</span><span class="op">,</span><span class="st">&quot;type&quot;</span><span class="dt">:</span><span class="st">&quot;feed&quot;</span><span class="op">,</span><span class="st">&quot;capabilities&quot;</span><span class="dt">:[</span><span class="st">&quot;add&quot;</span><span class="op">,</span><span class="st">&quot;get&quot;</span><span class="op">,</span><span class="st">&quot;iterator&quot;</span><span class="op">,</span><span class="st">&quot;remove&quot;</span><span class="dt">]}</span></span></code></pre></div>
<p>Copy the id. We’re going to use it in the next step.</p>
<h4 id="running-another-copy-of-the-data-store">Running another copy of the data store</h4>
<p>On your second machine, make sure you have IPFS running and the OrbitDB REST server installed and running.</p>
<p>Replicating the my-feed data simply requires you query the first machine’s my-feed data store using the full address. Using the address of the my-feed data store I queried earlier, request the data:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> https://localhost:3000/db/zdpuAzCDGmFKdZuwQzCZEgNGV9JT1kqt1NxCZtgMb4ZB4xijw%2Fmy-feed/all</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[</span><span class="st">&quot;A beginner&#39;s guide to OrbitDB REST API&quot;</span><span class="ex">]</span></span></code></pre></div>
<p>You may need to run the curl call a couple of time; OrbitDB will take a small amount of time to replicate the data over.</p>
<p>There are two important things to note about the address; 1) we drop the /orbitdb/ prefix and 2) we need to url encode the /. The html encoded value of / is %2F.</p>
<p>And that’s it. You have successfully created a new OrbitDB data store on one machine and replicated across another.</p>
<p>Let’s test it out. Back on your first machine, add another entry to the feed data store:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST https://localhost:3000/db/my-feed/add <span class="at">--data-urlencode</span> <span class="st">&quot;Learning about IPFS&quot;</span></span></code></pre></div>
<p>On your second machine, retrieve the feed list again:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> https://localhost:3000/db/zdpuAzCDGmFKdZuwQzCZEgNGV9JT1kqt1NxCZtgMb4ZB4xijw%2Fmy-feed/all</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[</span><span class="st">&quot;A beginner&#39;s guide to OrbitDB REST API&quot;</span><span class="ex">,</span><span class="st">&quot;Learning about IPFS&quot;</span><span class="ex">]</span></span></code></pre></div>
<h4 id="adding-data-in-a-decentralized-environment">Adding data in a decentralized environment</h4>
<p>What happens if you want to add more entries to the my-feed data store from your second machine:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST https://localhost:3000/db/my-feed/add <span class="at">--data-urlencode</span> <span class="st">&quot;Adding an item from the second OrbitDB REST peer.&quot;</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="ex">{</span><span class="st">&quot;statusCode&quot;</span><span class="ex">:500,</span><span class="st">&quot;error&quot;</span><span class="ex">:</span><span class="st">&quot;Internal Server Error&quot;</span><span class="ex">,</span><span class="st">&quot;message&quot;</span><span class="ex">:</span><span class="st">&quot;Error: Could not append entry, key </span><span class="dt">\&quot;</span><span class="st">03cc598325319e6c07594b50880747604d17e2be36ba8774cd2ccce44e125da236</span><span class="dt">\&quot;</span><span class="st"> is not allowed to write to the log&quot;</span><span class="ex">}</span></span></code></pre></div>
<p>If you check the output from your REST server you will see a permissions error. By default, any replicating node will not be able to write back to the data store. Instead, we have tell the originating OrbitDB instance that the second instance can also write to the my-feed data store. To do this, we must manually add the public key of the second OrbitDB instance to the first instance.</p>
<p>It is important to note that the data store must be created with an access controller pre-specified. Start by deleting the data store on the first machine:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> DELETE https://localhost:3000/db/my-feed</span></code></pre></div>
<p>We must now set up the my-feed database again and add some data:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST https://localhost:3000/db/feed.new <span class="at">-H</span> <span class="st">&quot;Content-Type: application/json&quot;</span> <span class="at">--data</span> <span class="st">&#39;{&quot;create&quot;:&quot;true&quot;,&quot;type&quot;:&quot;feed&quot;,&quot;accessController&quot;:{&quot;type&quot;: &quot;orbitdb&quot;,&quot;write&quot;: [&quot;048161d9685991dc87f3e049aa04b1da461fdc5f8a280ed6234fa41c0f9bc98a1ce91f07494584a45b97160ac818e100a6b27777e0b1b09e6ba4795dcc797a6d8b&quot;]}}&#39;</span></span></code></pre></div>
<p>Note the accessController property; this specify the controller type and the key which can write to the database. In this case it is the first machine’s public key, which can be retrieved by running:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> https://localhost:3000/identity</span></code></pre></div>
<p>On the second machine, retrieve the public key:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> https://localhost:3000/identity</span></code></pre></div>
<p>Grab the publicKey value. We will now enable write access to the my-feed database:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> PUT https://localhost:3000/db/feed.new/access/write <span class="at">--data</span> <span class="st">&#39;publicKey=04072d1bdd0e5e43d9e10619d997f6293f4759959e19effb958785b7f08413fb81501496a043385c245dedc952ee01c06bc9c654afe79b11dd5f130796baf8d2da&#39;</span></span></code></pre></div>
<p>publicKey will be the publicKey of the second machine. We must execute this request from the first machine because only the first machine currently has write permissions to the data store.</p>
<p>With the second machine’s publickey added, we can go ahead and add a new my-feed from the second machine:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST https://localhost:3000/db/my-feed/add <span class="at">--data-urlencode</span> <span class="st">&quot;Adding an item from the second OrbitDB REST peer.&quot;</span></span></code></pre></div>
<h3 id="key-takeaways-6">Key takeaways</h3>
<ul>
<li>You can communicate with OrbitDB using something other than NodeJS,</li>
<li>The RESTful API provides you with a rich set of features which you can use to implement powerful distributed data stores in other programming languages,</li>
<li>The data stores you create using the RESTful API can be replicated elsewhere.</li>
</ul>
<p>A full list of available RESTful endpoints as well as installation and other documentation is available on the official <a href="https://github.com/orbitdb/orbit-db-http-api">OrbitDB HTTP API Github</a> repository.</p>
<h2 id="workshop-creating-your-own-store">Workshop: Creating Your Own Store</h2>
<ul>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/342">342</a> Data persistence on IPFS</li>
</ul>
<h1 id="part-4-whats-next">Part 4: What’s Next?</h1>
<h2 id="introduction-4">Introduction</h2>
<ul>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/364">364</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/377">377</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/442">442</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/386">386</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/434">434</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/501">501</a></li>
<li>Resolves #<a href="https://github.com/orbitdb/orbit-db/issues/504">504</a></li>
</ul>
<h2 id="distributed-identity">Distributed Identity</h2>

<h2 id="encryption-breakthroughs">Encryption Breakthroughs</h2>

<h2 id="why-the-web-is-still-critical-in-peer-to-peer">Why the Web is still critical in peer-to-peer</h2>
<h3 id="overview">Overview</h3>
<h3 id="progressive-web-apps">Progressive Web Apps</h3>
<h3 id="using-orbitdb-in-a-web-worker">Using OrbitDB in a Web Worker</h3>

<h1 id="part-5-customizing-orbitdb">Part 5: Customizing OrbitDB</h1>
<p>In the first chapter of this Field Manual, we described how you might create a couple of built-in OrbitDB databases and write code to modify it.</p>
<p>We shall try to build on this tutorial to show you, how you can customize the built-in OrbitDB stores and indices or how you can define your own.</p>
<h2 id="what-will-we-implement">What will we implement?</h2>
<p>We have already implemented a sheet music sharing app, where musicians can upload and share their notes as files and view those of other musicians.</p>
<p>But what they cannot do, is cooperate with each other. And isn’t it with cooperation, that the greatest strengths of the internet come to bear?</p>
<p>So we want to allow our users to not just share musical notes, but also comment on each others notes and discuss them.</p>
<h2 id="what-do-you-need-to-read-to-understand-this-chapter">What do you need to read to understand this chapter?</h2>
<p>It is not expected that you have read all of this Field Manual to understand this chapter.</p>
<p>But you should have read these documents before reading this chapter:</p>
<ol type="1">
<li><a href="../01_Tutorial/00_Introduction.md">The Tutorial</a></li>
<li><a href="../03_The_Architecture_of_OrbitDB/02_ipfs-log.md">ipfs-log</a></li>
</ol>
<p>You may not need to understand entirely what the <code>ipfs-log</code> is, but you should know that it exists and that it is the basis of all OrbitDB Stores.</p>
<p><strong>Next: <a href="./01_Definitions.md">What are Stores, AccessControllers and Indicies.</a></strong></p>
<h2 id="what-are-stores-accesscontrollers-and-indicies.">What are Stores, AccessControllers and Indicies.</h2>
<p>Before we start to implement our custom store, access controller, and index to allow our users to comment on each others notes, we should probably define what a <code>Store</code>, <code>AccessController</code>, and <code>Index</code> are and what function they have in OrbitDB.</p>
<h3 id="the-store">The Store</h3>
<p>You have already worked with several Stores in the Tutorial. The <code>docstore</code> was used to store the individual pieces (or rather their CIDs) and the <code>kvstore</code> type was used to represent a user.</p>
<p>Both of those were instances of a <code>Store</code>. They calculated some state from <code>ipfs-log</code> and provided easy functions to access them, like <code>get</code>, <code>put</code> or <code>set</code>, with which you could easily interact with the database itself.</p>
<h3 id="the-index">The Index</h3>
<p>But a store doesn’t actually store the current state of the database in the RAM, because this is done in the <code>Index</code>.</p>
<p>The index parses the log of operations generated by the store while modifying the database and generates an easy to access and use representation of the current state of the database.</p>
<p>The index is then used by the <code>Store</code> to implement its API.</p>
<h3 id="the-access-controllers">The Access Controllers</h3>
<p>Access Controllers or short ACL (Access Control List) were already discussed <a href="../01_Tutorial/02_Managing_Data">02: Managing Data</a>.</p>
<p>They are a piece of code that is invoked whenever you try to write to the database to ensure that you have the right to do so.</p>
<p>It is setup when you create a database and stored in the Manifest of the database. (The multihash <code>zdpuAmQhKvDytoSn6NapRYZYTAWgqQpbJBfPLmUiSRBYgN7ah</code>in is refering to the Manifest file.<code>/orbitdb/zdpuAmQhKvDytoSn6NapRYZYTAWgqQpbJBfPLmUiSRBYgN7ah/example</code>)</p>
<p>Anyone, who supports this type of access controller, can follow the rules of the access controller.</p>
<p>But this also means, that you cannot change the type of your Access Controller, without changing the Manifest file and thus the OrbitDB Address.</p>
<p><strong>Next: <a href="02_Choosing_a_data_structure.md">Choosing a data structure</a></strong></p>
<h2 id="choosing-a-data-structure">Choosing a data structure</h2>
<p>Let’s start implementing a comment system by choosing how we want to represent the comments in the Index.</p>
<p>Choosing a data structure first and working our way outwards to the store API, that best fits to the data structure and then implementing the Access Controller, since the Access Controller is very much independent from the Store and Index.</p>
<h3 id="requirements-1">Requirements</h3>
<p>Our data structure should achieve two things:</p>
<ul>
<li>It should store the CID of the sheet music and a string denoting the instrument.</li>
<li>It should also store the comments, which themselves refer to a sheet music CID or a previous comment.</li>
</ul>
<p>The simplest data structure that could fulfill these requirements would be a collection of trees. Each tree’s root would be the Notes pieces and the children of that root would be the comments, the comments comments and so on and so on.</p>
<h3 id="generating-the-trees-from-the-ipfs-log">Generating the Trees from the <code>ipfs-log</code></h3>
<p>Before starting to implement this data structure, we’ll also have to consider, how to generate these trees from the oplog or <code>ipfs-log</code>.</p>
<p>In the index, we’ll see the oplog as an Array of operations, each containing these fields:</p>
<ul>
<li><code>op</code> to denote the operation being made</li>
<li><code>key</code> some key, that we can set if we so choose.</li>
<li><code>value</code> the value of the actual operation.</li>
</ul>
<p>For our purposes there can be these operations:</p>
<ul>
<li><code>ADDNOTES</code> to add a new piece of notes.</li>
<li><code>DELETENOTES</code> to delete a piece of notes.</li>
<li><code>ADDCOMMENT</code> to add a comment to a piece of notes or some other comments.</li>
<li><code>DELETECOMMENT</code> to delete a comment.</li>
</ul>
<p>This seems pretty straight forward.</p>
<h3 id="what-happens-when-we-delete-notes-or-comments-with-all-those-comments-referring-to-them">What happens when we delete notes or comments, with all those comments referring to them?</h3>
<p>I propose using a simple rule: If a comment or piece of notes is deleted, all those refering to it are deleted too. Otherwise this tutorial becomes a complicated mess.</p>
<h2 id="implementing-the-index.">Implementing the Index.</h2>
<p>Let’s start by adding a new file to your project folder (if you haven’t yet created one, do that now).</p>
<h3 id="isomorphic-bookends.">Isomorphic Bookends.</h3>
<p>You know the drill, before starting with the actual implementation of the Index, we have to define the bookends, that make our code work in the browser and in NodeJS:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;use strict&quot;</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> {</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> NotesIndex</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>} <span class="cf">catch</span> (e) {</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">window</span><span class="op">.</span><span class="at">NotesIndex</span> <span class="op">=</span> NotesIndex</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Not that complicated, really. Because an Index does not actually depend libraries from OrbitDB.</p>
<p>It is using duck typing, instead of inheritance.</p>
<h3 id="defining-the-notesindex-class.">Defining the <code>NotesIndex</code> class.</h3>
<p>Next, let’s define the actual class of the <code>NotesIndex</code>. Add this to your file, between the bookends and the <code>use strict</code>.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NotesIndex {</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_index</span> <span class="op">=</span> {}</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We initialize the index to an empty object at first, because we don’t yet have any data.</p>
<h3 id="defining-the-treenode-helper-class.">Defining the <code>TreeNode</code> helper class.</h3>
<p>After this, let’s first implement our own <code>TreeNode</code> data type, that’ll be used to represent the trees mentioned above.</p>
<p>Because Trees are fundamentally recursive data structures, a Tree and a <code>TreeNode</code> are the same thing. Both hold some data and have some children, who are of type <code>TreeNode</code>.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TreeNode {</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(data) {</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> data</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">children</span> <span class="op">=</span> []</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addChild</span>(data) {</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> node <span class="op">=</span> <span class="kw">new</span> <span class="fu">TreeNode</span>(data)</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">children</span><span class="op">.</span><span class="fu">push</span>(node)</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> node</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>With this utility class, we can now get on to implementing the Index API.</p>
<p><strong><a href="03_Defining_the_Index.md">Next: Defining the Index</a></strong></p>
<h2 id="defining-the-index">Defining the Index</h2>
<p>In the last chapter we considered how we could define our <code>Index</code> data structure.</p>
<p>I settled us on a Tree data structure, where each notes piece are a root and the comments would be children of that root.</p>
<p>We then laid out the skeleton code for the Index and in this chapter we will actually define the Index or what makes the <code>NotesIndex</code> class an <code>Index</code>.</p>
<h3 id="a-few-utility-functions.">A few utility functions.</h3>
<p>Let’s first define a few utility functions for fetching content from the <code>Index</code>.</p>
<ul>
<li>Fetching a notes piece.</li>
<li>Fetching the comments on a piece of notes</li>
<li>Getting comments in a chronological order for a specific piece of notes.</li>
</ul>
<p>The last will be very helpful to UI Designers who have the crucial task of translating this data structure into pleasant UI.</p>
<h4 id="getnotes"><code>getNotes</code></h4>
<p>But let’s start with a simple <code>NotesIndex.getNotes</code> function.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getNotes</span>(cid) {</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">_index</span>[cid]<span class="op">.</span><span class="at">data</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We fetch the tree with that CID and then only care for the <code>data</code> field of the <code>TreeNode</code>, because that’s where the sheet music is actually stored.</p>
<h4 id="getcomments"><code>getComments</code></h4>
<p>Now implement the <code>NotesIndex.getComments(cid)</code> function like this:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getComments</span>(cid) {</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">_index</span>[cid]<span class="op">.</span><span class="at">children</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Get comments is almost entirely identical to <code>getNotes</code>, except that we don’t return the <code>data</code>, but the <code>children</code> field of the <code>TreeNode</code>.</p>
<h4 id="getcomments-with-chronological-order"><code>getComments</code> with chronological order</h4>
<p>Now, let’s get to our third and final <code>get</code> functions: <code>getComments</code>, but now with an argument: <code>flat = true</code>. The purpose of this function is, to if the <code>flat</code> argument is true, flatten the comments into a neat chronological list, that can be easily displayed. To do this, we first gather all of the comments into an array and then sort them based on an ever increased <code>id</code> field:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getComments</span>(cid<span class="op">,</span> flat <span class="op">=</span> <span class="kw">true</span>) {</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">flatten</span>(children) {</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> children<span class="op">.</span><span class="fu">reduce</span>((comments<span class="op">,</span> comment) <span class="kw">=&gt;</span> {</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>      comments<span class="op">.</span><span class="fu">push</span>(comment<span class="op">.</span><span class="at">data</span>)</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> comments<span class="op">.</span><span class="fu">concat</span>(<span class="fu">flatten</span>(comment<span class="op">.</span><span class="at">children</span>))</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> [])</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(flat) {</span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">flatten</span>(<span class="kw">this</span><span class="op">.</span><span class="at">_index</span>[cid]<span class="op">.</span><span class="at">children</span>)<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a<span class="op">.</span><span class="at">id</span> <span class="op">-</span> b<span class="op">.</span><span class="at">id</span>)</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">_index</span>[cid]<span class="op">.</span><span class="at">children</span></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Replace the <code>getComments</code> function above, by this.</p>
<h5 id="what-happens-here">What happens here?</h5>
<p>We first define a helper function <code>flatten</code>, which goes through the array of children and adds each node of the tree therein to a flat array. Then we sort it based on an id field in ascending order. If you pass in <code>flat = false</code>, you’ll still get the old behavior.</p>
<h4 id="the-updateindex-function">The <code>updateIndex</code> function</h4>
<p>Up until this point, we have been writing utility functions that are nice to have for our index to be used by our still to be defined store, but is not strictly necessary for an <code>Index</code> to work as such.</p>
<p>The only method all <code>Index</code> classes have to have is <code>updateIndex</code>.</p>
<p><code>updateIndex</code> receives as an argument the <code>oplog</code> of database, which is an Array of Operations compiled from the <code>ipfs-log</code> in chronological order.</p>
<p>So, let’s lay out the skeleton:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">updateIndex</span>(oplog) {</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> order <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  oplog<span class="op">.</span><span class="at">values</span><span class="op">.</span><span class="fu">reduce</span>((handled<span class="op">,</span> item) <span class="kw">=&gt;</span> {</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="op">!</span>handled<span class="op">.</span><span class="fu">includes</span>(item<span class="op">.</span><span class="at">hash</span>)) {</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>      handled<span class="op">.</span><span class="fu">push</span>(item<span class="op">.</span><span class="at">hash</span>)</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">switch</span> (item<span class="op">.</span><span class="at">payload</span><span class="op">.</span><span class="at">op</span>)) {</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;ADDNOTES&quot;</span><span class="op">:</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;DELETENOTES&quot;</span><span class="op">:</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;ADDCOMMENT&quot;</span><span class="op">:</span></span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;DELETECOMMENT&quot;</span><span class="op">:</span></span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> [])</span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>updateIndex</code> starts with a line, that initializes an <code>order</code> variable to 0. This will help us when we get to <code>ADDCOMMENT</code>.</p>
<p>We start by reducing the <code>oplog.values</code> Array. The accumulator of the reducer contains the hashes of the items that have already been handled. The current item is checked, not to have been handled already and is then added to the handled array.</p>
<p>After this, the handling actually starts. We use a switch statement to handle the item’s differently based on the <code>op</code> value. As we discussed in the previous chapter, there are four operations, that this Index can handle:</p>
<ul>
<li><code>ADDNOTES</code> to add a new piece of notes.</li>
<li><code>DELETENOTES</code> to delete a piece of notes.</li>
<li><code>ADDCOMMENT</code> to add a comment to a piece of notes or some other comments.</li>
<li><code>DELETECOMMENT</code> to delete a comment.</li>
</ul>
<h4 id="implementing-addnotes-handling">Implementing <code>ADDNOTES</code> handling</h4>
<p>Add notes is by far the simplest operation to handle, since we just need to add a new <code>TreeNode</code> to the <code>_index</code>.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="st">&quot;ADDNOTES&quot;</span><span class="op">:</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">_index</span>[item<span class="op">.</span><span class="at">hash</span>] <span class="op">=</span> <span class="kw">new</span> <span class="fu">TreeNode</span>(item<span class="op">.</span><span class="at">payload</span><span class="op">.</span><span class="at">value</span>)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">break</span><span class="op">;</span></span></code></pre></div>
<h4 id="implementing-deletenotes-handling">Implementing <code>DELETENOTES</code> handling</h4>
<p>And deleting notes is the inverse:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="st">&quot;DELETENOTES&quot;</span><span class="op">:</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">delete</span> <span class="kw">this</span><span class="op">.</span><span class="at">_index</span>[item<span class="op">.</span><span class="at">hash</span>]</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">break</span><span class="op">;</span></span></code></pre></div>
<h4 id="implementing-addcomment-handling">Implementing <code>ADDCOMMENT</code> handling</h4>
<p>Adding comments is a little more complicated. We first have to find the parent of the comment in the notes or among the comments themselves.</p>
<p>To do this properly in adequate time, we have to add a <code>_comments</code> property to our <code>Index</code> in the <code>constructor</code>:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">constructor</span>() {</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">_index</span> <span class="op">=</span> {}</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">_comments</span> <span class="op">=</span> {}</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>In this object, we store each comment’s <code>TreeNode</code> by it’s hash or rather the hash of the Oplog <code>Entry</code> that added them for easy access.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="st">&quot;ADDCOMMENT&quot;</span><span class="op">:</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> reference <span class="op">=</span> item<span class="op">.</span><span class="at">payload</span><span class="op">.</span><span class="at">key</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> node <span class="op">=</span> {</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">comment</span><span class="op">:</span> item<span class="op">.</span><span class="at">payload</span><span class="op">.</span><span class="at">value</span><span class="op">,</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">author</span><span class="op">:</span> item<span class="op">.</span><span class="at">identity</span><span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span><span class="op">:</span> order</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>  order<span class="op">++</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="kw">this</span><span class="op">.</span><span class="at">_index</span>[item<span class="op">.</span><span class="at">payload</span><span class="op">.</span><span class="at">key</span>] <span class="op">!==</span> <span class="kw">undefined</span>) {</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>    node <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">_index</span>[item<span class="op">.</span><span class="at">payload</span><span class="op">.</span><span class="at">key</span>]<span class="op">.</span><span class="fu">addChild</span>(node)</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(<span class="kw">this</span><span class="op">.</span><span class="at">_comments</span>[item<span class="op">.</span><span class="at">payload</span><span class="op">.</span><span class="at">key</span>] <span class="op">!==</span> <span class="kw">undefined</span>){</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>    node <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">_index</span>[item<span class="op">.</span><span class="at">payload</span><span class="op">.</span><span class="at">key</span>]<span class="op">.</span><span class="fu">addChild</span>(node)</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">_comments</span>[item<span class="op">.</span><span class="at">hash</span>] <span class="op">=</span> node</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">break</span><span class="op">;</span></span></code></pre></div>
<p>This branch of the <code>ADDCOMMENT</code> switch starts by utilizing the <code>key</code> field of the Operation, which is interpreted as the hash of the notes pieces or the comments. Then the node of the comment is created containing both the comment, an <code>author</code> field, and an <code>id</code> field. The <code>author</code> field is set to the ID of the OrbitDB instance that is passed to the operation and already verified by OrbitDB.</p>
<p>And for the <code>id</code> we use the <code>updateIndex</code>-wide <code>order</code> variable, which is incremented afterwards. Because the <code>order</code> variable is increased for each comment on each note. This makes it possible to sort the comments in <code>getComments</code>.</p>
<p>After this, the <code>TreeNode</code> that is referred to by the Operator’s <code>key</code> field, gets a new child in the form of the comment.</p>
<p>And at last, we store the created <code>TreeNode</code>, in <code>_comments</code> for later.</p>
<h4 id="implementing-deletecomment-handling">Implementing <code>DELETECOMMENT</code> handling</h4>
<p>After the monster of a branch above, this case is pretty relaxing in comparison:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="st">&quot;DELETECOMMENT&quot;</span><span class="op">:</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> comment <span class="op">=</span> item<span class="op">.</span><span class="at">payload</span><span class="op">.</span><span class="at">key</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">delete</span> <span class="kw">this</span><span class="op">.</span><span class="at">_comments</span>[item<span class="op">.</span><span class="at">hash</span>]</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">break</span><span class="op">;</span></span></code></pre></div>
<h3 id="conclusion-1">Conclusion</h3>
<p>We have now defined the complete <code>Index</code> for the comment system. You can now read it through the <code>getNotes</code> and <code>getComments</code>.</p>
<p>But we haven’t discussed two topics yet:</p>
<ul>
<li>How do you add data to the database?</li>
<li>And how can you ensure, that the database isn’t modified incorrectly? How can we ensure that user A doesn’t delete the comment of user B?</li>
</ul>
<p>Both of those question will be addressed in the next chapters of this Tutorial. First, in the Store chapters, we discuss, how you can add data to the database.</p>
<p>And in the chapters about the Access Controller we will at the end of this Tutorial discuss, how you can control, how can change what in your databases.</p>
<p><strong>Next: <a href="04_Defining_the_Store.md">Defining the Store</a></strong></p>
<h2 id="defining-the-store">Defining the Store</h2>
<p>We now have our own <code>Index</code> in <code>NotesIndex.js</code>.</p>
<p>But how can we use it? Through the <code>Store</code>.</p>
<p>The Store, as we know, actually does not store the state of the Database, because this is the job of the <code>Index</code>.</p>
<p>The function of the job is to provide an easy to use, intuitive API for the end-user, such that they do not have to bother about things, like CRDTs, <code>ipfs-log</code> or the <code>DAG</code>.</p>
<p>You already know a lot of stores, at least if you read the first Tutorial in this Manual.</p>
<p>Because there are five built-in stores, which will I not bother recounting here.</p>
<h3 id="the-notesstore-class">The <code>NotesStore</code> class</h3>
<p>You should now add a new JavaScript file and call it <code>NotesStore.js</code>.</p>
<h4 id="isomorphic-bookends">Isomorphic Bookends</h4>
<p>For the third time in this Manual: Let’s define an isomorphic bookend:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">notesStore</span>(IPFS<span class="op">,</span> OrbitDB<span class="op">,</span> NotesIndex) {</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> {</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> IPFS <span class="op">=</span> <span class="pp">require</span>(<span class="st">&quot;ipfs&quot;</span>)</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> OrbitDB <span class="op">=</span> <span class="pp">require</span>(<span class="st">&quot;orbit-db&quot;</span>)</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> NotesIndex <span class="op">=</span> <span class="pp">require</span>(<span class="st">&quot;./NotesIndex&quot;</span>)</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>  module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> <span class="fu">notesStore</span>(IPFS<span class="op">,</span> OrbitDB)</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>} <span class="cf">catch</span> (e) {</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(e)</span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">window</span><span class="op">.</span><span class="at">NoteStore</span> <span class="op">=</span> <span class="fu">notesStore</span>(<span class="bu">window</span><span class="op">.</span><span class="at">Ipfs</span><span class="op">,</span> <span class="bu">window</span><span class="op">.</span><span class="at">OrbitDB</span><span class="op">,</span> <span class="bu">window</span><span class="op">.</span><span class="at">NotesIndex</span>)</span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We’ll from now on be working inside the <code>notesStore</code> function.</p>
<h3 id="defining-the-notesstore-class">Defining the <code>NotesStore</code> class</h3>
<p>To define a Store, we have to extend an existing Store class. For this Tutorial, we shall use the <code>EventStore</code> class.</p>
<p>Add the following as the body of the <code>notesStore</code> function:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteStore <span class="kw">extends</span> OrbitDB<span class="op">.</span><span class="at">EventStore</span> {</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(ipfs<span class="op">,</span> id<span class="op">,</span> dbname<span class="op">,</span> options) {</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="op">!</span>options<span class="op">.</span><span class="at">Index</span>) <span class="bu">Object</span><span class="op">.</span><span class="fu">assign</span>(options<span class="op">,</span> { <span class="dt">Index</span><span class="op">:</span> NotesIndex })</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>(ipfs<span class="op">,</span> id<span class="op">,</span> dbname<span class="op">,</span> options)</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_type</span> <span class="op">=</span> NoteStore<span class="op">.</span><span class="at">type</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_ipfs</span> <span class="op">=</span> ipfs</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> get <span class="fu">type</span> () {</span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;noteStore&quot;</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> NoteStore</span></code></pre></div>
<h4 id="what-is-happening-here">What is happening here?</h4>
<p>The Store receives four parameters in it’s <code>constructor</code>:</p>
<ul>
<li><code>ipfs</code> - the IPFS instance passed to OrbitDB.createInstance</li>
<li><code>id</code> - the id of this database</li>
<li><code>dbname</code> - the name of the database and last part of the orbitdb addresses.</li>
<li><code>options</code> - Object of options. Most important for our purposes is the <code>Index</code> option. It is the <code>Index</code> class, used by the database.</li>
</ul>
<p>In the first line of the <code>constructor</code> the <code>Index</code> option is set to <code>NotesIndex</code>, unless the options already has an <code>Index</code> specified.</p>
<p>Besides this, all stores have to have a <code>type</code> property, to uniquely identify the <code>NotesStore</code>.</p>
<h3 id="defining-a-getnotes-and-getcomments">Defining a <code>getNotes</code> and <code>getComments</code></h3>
<p>We should probably implement a few get functions. But this is really low effort, since we already implemented a <code>getNotes</code> and <code>getComments</code> function on the Index and thus we can implement the <code>NotesStore.getNotes</code> and <code>NotesStore.getComments</code>:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getNotes</span>(cid) {</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">_index</span><span class="op">.</span><span class="fu">getNotes</span>(cid)</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a><span class="fu">getComments</span>(cid<span class="op">,</span> flat <span class="op">=</span> <span class="kw">true</span>) {</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">_index</span><span class="op">.</span><span class="fu">getComments</span>(cid<span class="op">,</span> flat <span class="op">=</span> flat)</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>As you can see, <code>this._index</code> is an instance of the <code>NotesIndex</code>, if no other Index was passed in to the constructor, and we can easily access the methods we defined in the Index.</p>
<h3 id="adding-data-to-the-store">Adding Data to the Store</h3>
<p>Now, let’s finally add some data to our Store.</p>
<p>First, we should make it possible to add a Notes Piece by it’s CID:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">addNotesByCID</span>(cid<span class="op">,</span> mime<span class="op">,</span> instrument <span class="op">=</span> <span class="st">&quot;piano&quot;</span><span class="op">,</span> options <span class="op">=</span> {}) {</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_addOperation</span>({</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">op</span><span class="op">:</span> <span class="st">&quot;ADDNOTES&quot;</span><span class="op">,</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">key</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">value</span><span class="op">:</span> {</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">cid</span><span class="op">:</span> cid<span class="op">,</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">mime</span><span class="op">:</span> mime<span class="op">,</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">instrument</span><span class="op">:</span> instrument</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> options)</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><em>The <code>NotesStore.addNotesByCID</code> method</em></p>
<p>As you can see, we use an <code>_addOperation</code> method, which adds an operation to the <code>ipfs-log</code> or <code>oplog</code>, which meets us again in the <code>updateIndex</code> method.</p>
<p><code>_addOperation</code> returns a <code>Promise&lt;CID&gt;</code>, so a promise of the hash of the operation entry in the oplog.</p>
<p>And we also define a format for the notes:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>value<span class="op">:</span> {</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">cid</span><span class="op">:</span> cid<span class="op">,</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">mime</span><span class="op">:</span> mime<span class="op">,</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">instrument</span><span class="op">:</span> instrument</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="addnotesbinary"><code>addNotesBinary</code></h3>
<p>But we can still do more for the user in this store. <code>addNotesByCID</code> adds a notes file by it’ CID. But this expects the notes file to have been added to IPFS, something that we can do automatically, since we stored the IPFS Node in the <code>this._ipfs</code> variable.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">addNotesBinary</span>(binary<span class="op">,</span> mime<span class="op">,</span> instrument <span class="op">=</span> <span class="st">&quot;piano&quot;</span><span class="op">,</span> options <span class="op">=</span> {}) {</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> {cid} <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">_ipfs</span><span class="op">.</span><span class="fu">add</span>(binary)</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(options<span class="op">.</span><span class="at">pin</span>) <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">_ipfs</span><span class="op">.</span><span class="at">pin</span><span class="op">.</span><span class="fu">add</span>(cid)</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">addNotesByCID</span>(cid<span class="op">.</span><span class="fu">toString</span>()<span class="op">,</span> mime<span class="op">,</span> instrument <span class="op">=</span> instrument<span class="op">,</span> options <span class="op">=</span> options)</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This method adds the <code>Uint8Array</code> <code>binary</code> to IPFS. It then pins the data to the local IPFS Node, if the <code>options.pin</code> boolean is <code>true</code>.</p>
<p>Afterwards, it calls the <code>addNotesByCID</code> function, with the generated <code>cid</code>.</p>
<p>This is just an example of how you can make the Store API encompass more, than just adding operations to the <code>oplog</code>.</p>
<p>For some other ideas of what can be done in the store, prior to adding an operation:</p>
<ul>
<li>Formatting (with Protobuf)</li>
<li>Encryption and Decryption</li>
</ul>
<h4 id="adding-comments">Adding Comments</h4>
<p>After a user added their musical notes to their Database, users might want to add comments to the notes.</p>
<p>Let’s add an <code>addComment</code> method.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">addComment</span>(text<span class="op">,</span> reference) {</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="kw">this</span><span class="op">.</span><span class="at">_index</span><span class="op">.</span><span class="fu">getNotes</span>(reference) <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">||</span> <span class="kw">this</span><span class="op">.</span><span class="at">_index</span><span class="op">.</span><span class="at">_comments</span>[reference] <span class="op">!==</span> <span class="kw">undefined</span>) {</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>     <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_addOperation</span>({</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>       <span class="dt">op</span><span class="op">:</span> <span class="st">&quot;ADDCOMMENT&quot;</span><span class="op">,</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>       <span class="dt">key</span><span class="op">:</span> reference<span class="op">,</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>       <span class="dt">value</span><span class="op">:</span> text</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>     })</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">null</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>You might observe, that this function performs some validation prior to creating the operation, ensuring that the reference actually exists. This is one way how you can use the store, too, but you might want to do this in the index instead.</p>
<p>By the way, all operations are signed by your OrbitDB Identity on creation and we thus don’t need to add any further information about the auther. See the <a href="03_Defining_the_Index.md#Implementing-ADDCOMMENT-handling">Implementing <code>ADDCOMMENT</code> handling</a> section of the previous chapter.</p>
<h2 id="other-stores">Other Stores</h2>
<p>You might note that this is a very complicated custom store and index. But the actual techniques used are deployed already in all of the built-in Stores.</p>
<p>So, if you want further examples of how you could implement your own custom stores, reading the source code of the <code>*Store.js</code> and <code>*Index.js</code> file can be very illuminating and inspiring.</p>
<p>I would advice reading the <a href="https://github.com/orbitdb/orbit-db-eventstore/blob/main/src/EventIndex.js"><code>EventIndex.js</code></a> and the <a href="https://github.com/orbitdb/orbit-db-kvstore/blob/main/src/">KVStore’s Store and Index files</a>.</p>
<h2 id="key-takeaways-7">Key Takeaways</h2>
<ul>
<li>Stores inherit from each other. So you can extend built-in stores.</li>
<li>Stores work with the <code>Index</code> and the <code>this._addOperation</code> mostly.</li>
<li><code>this._addOperation</code> adds an operation to the oplog and you can specify the <code>payload</code> field of each operation here.</li>
<li>Stores can also do more, than just reading and writing from the database, like:
<ol type="1">
<li>You can use them to implement custom encryption/decryption</li>
<li>Format your data in specific ways (protobuf?)</li>
</ol></li>
</ul>
<p><strong>Next: <a href="05_Conclusion.md">Conclusion</a></strong></p>
<h2 id="on-customizing-orbitdb">On Customizing OrbitDB</h2>
<p>In conclusion this part of the Field Manual of OrbitDB tried to introduce the reader to customizing the OrbitDB Stores by defining <code>Index</code> and <code>Store</code> types.</p>
<p>It started with the <code>Index</code> to define the current working state of the database.</p>
<p>Here the tutorial was trying to introduce the parsing of the <code>oplog</code> - an Array of Operations - to create this state.</p>
<p>After the <code>Index</code> - state of the database - being defined, the tutorial defines a <code>Store</code> class.</p>
<p>The <code>Store</code> class does not manage the current state, but use the <code>Index</code> to create an easy to use API for a User, who just wants to use the Database and has no time to bother about CRDTs, <code>oplogs</code> and other such complexities.</p>
<h3 id="where-to-go-from-here">Where to go from here?</h3>
<p>The source code in this tutorial is incomplete by design. You can extend it, add more features, change the API or parse the state differently.</p>
<p>Some ideas, that you could pursue - but don’t have to:</p>
<ul>
<li>Event Handling: Firing events when receiving <em>new</em> comments, notes and deleting old ones.</li>
<li>Make it possible to edit comments.</li>
<li>Use a different data structure to represent the comments: A lazy hash table, where each notes piece and comment can be looked up and parsed upon request, instead of upon receiving new entries.</li>
<li>Use a different delete heuristic: Don’t delete comments, if the comments or music sheets they refer to are deleted. Do something else! Maybe move them up the tree or put them into a <code>detached comments</code> array. It’s a question of your imagination.</li>
</ul>
<p>You are free to change the source code here however you want. If you want to compare the code, that you have written over the course of this Tutorial with the code, we used to create this tutorial, you can download the final version of the code here: <a href="../code_examples/05_Customizing_OrbitDB/final">final</a>.</p>
<p>We also have an Appendix to this part of the tutorial, that describes how you can use the <code>AccessControllers</code> with OrbitDB to moderate the discussions about the notes.</p>
<p>If you want to read that, go to this: <strong><a href="06_AccessControllers.md">Moderating your Comment Threads.</a></strong></p>
<h2 id="moderating-your-comment-threads.">Moderating your Comment Threads.</h2>
<p>We have now gotten a store that you can publish notes and comments with.</p>
<p>But you cannot actually control who and what gets to comment and count as a valid comment.</p>
<p>In other words: How can you moderate a Peer-to-Peer Database?</p>
<p>Well, you can’t really. Or at least, you cannot moderate data on another persons computer.</p>
<p>I cannot delete a file on your computer, anymore than you can delete a file on mine.</p>
<p>If either of us could do that, we would consider that malware.</p>
<p>And this is not a Tutorial on writing malware, so we’ll not go into it.</p>
<p>Moderating is generally considered to be two separate tasks:</p>
<ol type="1">
<li>Restricting the writing to a database</li>
<li>Restricting the reading from a database and sharing of contents.</li>
</ol>
<p>In a decentralized network, sharing data is easy. Once any peer has some data, they can share it essentially until their bandwidth runs out.</p>
<p>But writing control is more complex. We cannot prevent somebody from writing to their own local database, but we can decide, whether we will accept the local changes from another peer in our own database.</p>
<p>And there OrbitDB <code>AccessController</code>s come into action.</p>
<p>They are invoked when an OrbitDB instance receives new entries for a specific database and they determine, whether the OrbitDB Instance should accept and use these entries or deny and trash them.</p>
<p>Remember: These rules, that you write into the AccessController can be changed or ignored by other peers, if they so wish. But then again, consider whether it’s important to you what other peers do with their own database, as long as your database is clean and conforming to all the rules you laid out?</p>
<p>Additionally, if most peers follow your rules, then most content that violates these rules will not persist anyway, because nobody is around to pin it. Although in some cases for some specific data, somebody might be really insistent and pin it anyway.</p>
<p><strong>Next: <a href="06_Implementing_a_custom_AccessController.md">Implementing a custom AccessController</a></strong></p>
<h2 id="implementing-a-custom-access-controllers">Implementing a custom Access controllers</h2>
<p>And after these things, let us now consider how we might implement a custom access controller.</p>
<p>Starting with the rules, that we want to implement:</p>
<ul>
<li>The creator should be the only one to upload notes pieces.</li>
<li>Anyone can comment by default.</li>
<li>The author of a comment and the creator can delete a comment.</li>
<li>The creator can ban somebody from commenting on the entire database.</li>
</ul>
<h3 id="implementation">Implementation</h3>
<p>Similarly to the <code>Store</code>s, Access Controllers are implemented using inherited classes. Let’s implement a <code>NotesAccessController.js</code> file with these Isomorphic bookends:</p>
<p><strong>Note:</strong> TBD</p>
<h1 id="appendix-i-glossary">Appendix I: Glossary</h1>
<p>We use a lot of new terms in this tutorial that you may not have run across. In order to make it easier to look up what these terms are, we’ve added this short glossary. It also helps us to formalize what spelling or definitions we’re going with - ‘datastore’ over ‘data store’, isomorphic meaning platform agnostic as opposed to just frontend vs backend, etc.</p>
<p>A small note: We don’t have entries for abbreviations, such as IPFS for Interplanetary File System. Use your native search function to find the relevant entries.</p>
<h2 id="terms-to-use">Terms to use</h2>
<ul>
<li><strong>Conflict-free Replicated Data types (CRDTs)</strong>: In distributed computing, a conflict-free replicated data type (CRDT) is a data structure which can be replicated across multiple computers in a network, where the replicas can be updated independently and concurrently without coordination between the replicas, and where it is always mathematically possible to resolve inconsistencies which might result. <a href="https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type">Wikipedia</a></li>
<li><strong>database</strong>:</li>
<li><strong>datastore</strong>:</li>
<li><strong>eventual consistency</strong>: Operations can be taking place at places and times that you are unaware of, with the assumption that you’ll eventually connect with peers, share your logs, and sync your data. This contrasts with Blockchain’s idea of <em>strong consistency</em> where entries are added to the database only after they have been verified by some distributed consensus algorithm.</li>
<li><strong>Filecoin</strong>:</li>
<li><strong>InterPlanetary File System (IPFS)</strong>:</li>
<li><strong>isomorphic</strong>:</li>
<li><strong>js-ipfs</strong>: The JavaScript implementation of IPFS. <a href="https://github.com/ipfs/js-ipfs">GitHub</a>.</li>
<li><strong>packet switching</strong>: Packet switching is a method of grouping data that is transmitted over a digital network into packets. Packets are made of a header and a payload. Data in the header are used by networking hardware to direct the packet to its destination where the payload is extracted and used by application software. Packet switching is the primary basis for data communications in computer networks worldwide. <a href="https://en.wikipedia.org/wiki/Packet_switching">Wikipedia</a>.</li>
<li><strong>Paxos</strong>: Paxos is a family of protocols for solving consensus in a network of unreliable processors (that is, processors that may fail). Consensus is the process of agreeing on one result among a group of participants. This problem becomes difficult when the participants or their communication medium may experience failures. <a href="https://en.wikipedia.org/wiki/Paxos_(computer_science)">Wikipedia</a>.</li>
<li><strong>strong consistency</strong>: In this structural process, entries are added to a database only after they have been verified by some distributed consensus algorithm.</li>
</ul>
